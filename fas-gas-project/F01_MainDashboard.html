<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>OneGov FIT Market - Main Dashboard v265</title>
    <!-- Version 265: Fixed OEM/Vendor percentage calculations and table padding -->
    
    <!-- React 18 CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        :root {
            --dark-blue: #0a2240;
            --blue: #144673;
            --light-blue: #3a6ea5;
            --orange: #f47920;
            --bg-light: #f4f6f7;
            --text-light: #ffffff;
            --text-dark: #333333;
            --shadow: 0 2px 8px rgba(0,0,0,0.12);
            --border-radius: 8px;
            --green: #22c55e;
            --red: #ef4444;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--text-dark);
            min-height: 100vh;
            font-size: 16px;
        }
        
        /* Navigation Styles */
        .navbar {
            background: linear-gradient(135deg, var(--dark-blue) 0%, var(--blue) 100%);
            color: var(--text-light);
            padding: 1rem 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .nav-logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .nav-menu {
            display: flex;
            gap: 2rem;
            list-style: none;
        }
        
        .nav-menu a {
            color: var(--text-light);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
        }
        
        .nav-menu a:hover, .nav-menu a.active {
            background: rgba(255, 255, 255, 0.1);
            color: var(--orange);
        }
        
        /* Main Container */
        .main-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        
        .page-header {
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .page-title {
            font-size: 2.5rem;
            color: var(--dark-blue);
            margin-bottom: 0.5rem;
            font-weight: 700;
        }
        
        .page-subtitle {
            color: var(--blue);
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }
        
        /* Control Panel */
        .control-panel {
            background: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }
        
        .control-row {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .control-label {
            font-weight: 600;
            color: var(--dark-blue);
            font-size: 0.9rem;
        }
        
        .control-input {
            padding: 0.5rem;
            border: 2px solid #e5e7eb;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: var(--orange);
            color: white;
        }
        
        .btn-primary:hover {
            background: #e06d1c;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: var(--blue);
            color: white;
        }
        
        .btn-secondary:hover {
            background: var(--dark-blue);
        }
        
        /* Entity Grid */
        .entities-container {
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }
        
        .entities-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--bg-light);
        }
        
        .entities-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark-blue);
        }
        
        .entities-count {
            color: var(--blue);
            font-weight: 600;
        }
        
        .entities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        /* Entity Card */
        .entity-card {
            background: white;
            border: 2px solid #f0f0f0;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .entity-card:hover {
            border-color: var(--orange);
            box-shadow: var(--shadow);
            transform: translateY(-4px);
        }
        
        .entity-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--dark-blue);
            margin-bottom: 0.5rem;
        }
        
        .entity-type {
            background: var(--blue);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 1rem;
        }
        
        .entity-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--orange);
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: var(--blue);
            text-transform: uppercase;
        }
        
        /* Loading States */
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--blue);
        }
        
        .error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
            padding: 1rem;
            border-radius: var(--border-radius);
            margin: 1rem 0;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .control-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .entities-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .entities-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-menu {
                display: none;
            }
        }
        
        /* Entity Detail Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .modal-content {
            min-height: 100vh;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--dark-blue) 0%, var(--blue) 100%);
            color: white;
            padding: 16px 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .header-container {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .profile-card {
            background: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 24px;
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .profile-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .profile-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark-blue);
            margin-bottom: 8px;
        }
        
        .profile-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--blue);
        }
        
        .tier-badge {
            background: var(--green);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.8rem;
        }
        
        .action-links {
            display: flex;
            gap: 12px;
        }
        
        .action-link {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background-color 0.2s;
            border: none;
            cursor: pointer;
        }
        
        .website-link {
            background: var(--blue);
        }
        
        .website-link:hover {
            background: var(--dark-blue);
        }
        
        .linkedin-link {
            background: #0077B5;
        }
        
        .linkedin-link:hover {
            background: #005c8a;
        }
        
        .report-dropdown-btn {
            background: var(--orange);
        }
        
        .report-dropdown-btn:hover {
            background: #e67e22;
        }
        
        .close-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .content-container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 24px;
        }
        
        .section {
            margin-bottom: 32px;
        }
        
        .section-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--dark-blue);
            margin-bottom: 20px;
            padding-bottom: 8px;
            border-bottom: 3px solid var(--orange);
        }
        
        .overview-text {
            font-size: 1rem;
            line-height: 1.6;
            color: var(--text-dark);
            padding: 16px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid var(--orange);
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                üèõÔ∏è OneGov FIT Market
            </div>
            <ul class="nav-menu">
                <li><a href="#" class="active">üè† Dashboard</a></li>
                <li><a href="#" onclick="openReportBuilder()">üìä Builder</a></li>
                <li><a href="#">üìã Analytics</a></li>
                <li><a href="#">‚öôÔ∏è Settings</a></li>
                <li><a href="#" onclick="testAccessLogging()" style="background: #ff6b6b;">üß™ Test Log</a></li>
                <li><a href="#" onclick="simpleTest()" style="background: #00ff00; color: black;">‚úÖ SIMPLE TEST</a></li>
            </ul>
        </div>
    </nav>

    <div class="main-container">
        <div class="page-header">
            <h1 class="page-title">OneGov FIT Market Dashboard</h1>
            <p class="page-subtitle">Government Technology Marketplace Analytics & Intelligence Platform</p>
        </div>

        <div id="dashboardApp"></div>
    </div>

    <!-- Functions will be defined in React block -->

    <script type="text/babel">
        const { useState, useEffect } = React;

        console.log('React script starting...');
        window.formatCurrencyShort = function(value) {
            if (value === null || value === undefined || isNaN(value)) return '$0';
            
            const absValue = Math.abs(value);
            const sign = value < 0 ? '-' : '';
            
            if (absValue >= 1000000000) {
                return sign + '$' + (absValue / 1000000000).toFixed(1) + 'B';
            } else if (absValue >= 1000000) {
                return sign + '$' + (absValue / 1000000).toFixed(1) + 'M';
            } else if (absValue >= 1000) {
                return sign + '$' + (absValue / 1000).toFixed(1) + 'K';
            } else {
                return sign + '$' + absValue.toFixed(0);
            }
        };
        
        // Make formatCurrencyShort available globally for both React and non-React code
        const formatCurrencyShort = window.formatCurrencyShort;
        
        // Entity Detail Modal Functions
        window.showEntityDetail = function(entity, entityIndex) {
            console.log('üîç DEBUG: showEntityDetail called');
            console.log('üîç DEBUG: Entity name:', entity?.name);
            console.log('üîç DEBUG: Full entity object:', entity);
            
            // First test if google.script.run is available
            console.log('üîç DEBUG: google.script.run available?', typeof google?.script?.run);
            
            // Log access based on entity type
            if (entity && entity.type) {
                const entityType = entity.type.toLowerCase();
                
                if (entityType === 'oem') {
                    console.log('üìä Attempting to log OEM access...');
                    google.script.run
                        .withSuccessHandler((result) => console.log('‚úÖ OEM access logged successfully:', result))
                        .withFailureHandler((error) => console.error('‚ùå OEM access logging failed:', error))
                        .logOEMAccess();
                } else if (entityType === 'agency') {
                    console.log('üìä Attempting to log Agency access...');
                    google.script.run
                        .withSuccessHandler((result) => console.log('‚úÖ Agency access logged successfully:', result))
                        .withFailureHandler((error) => console.error('‚ùå Agency access logging failed:', error))
                        .logAgencyAccess();
                } else if (entityType === 'vendor') {
                    console.log('üìä Attempting to log Vendor access...');
                    google.script.run
                        .withSuccessHandler((result) => console.log('‚úÖ Vendor access logged successfully:', result))
                        .withFailureHandler((error) => console.error('‚ùå Vendor access logging failed:', error))
                        .logVendorAccess();
                }
            }
            
            // Store entity data for report generation
            window.currentEntityData = entity;
            
            // Process USAi profile data
            const profileData = processUSAiProfile(entity);
            console.log('üîç DEBUG: Profile data processed:', profileData);
            
            // Process entity data for charts
            const entityData = processEntityData(entity);
            console.log('üîç DEBUG: Entity data processed:', entityData);
            
            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'modal-overlay';
            
            // Generate modal HTML
            const modalHTML = createEntityModalHTML(entity, entityData, profileData);
            console.log('üîç DEBUG: Modal HTML length:', modalHTML.length);
            console.log('üîç DEBUG: Modal HTML includes "Get Profiles":', modalHTML.includes('Get Profiles'));
            modalOverlay.innerHTML = modalHTML;
            
            // Add to page
            document.body.appendChild(modalOverlay);
            console.log('üîç DEBUG: Modal added to DOM');
            
            // Check if button exists
            const profileButton = modalOverlay.querySelector('.report-dropdown-btn');
            console.log('üîç DEBUG: Profile button found:', !!profileButton);
            if (profileButton) {
                console.log('üîç DEBUG: Profile button onclick:', profileButton.onclick);
            }
            
            // Add click outside to close
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    modalOverlay.remove();
                }
            });
        };
        
        function createEntityModalHTML(entity, entityData, profileData) {
            return `
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="header-container">
                            <div class="entity-info">
                                <h1>${entity.name}</h1>
                                <div class="entity-meta">
                                    <span>Total Obligations: ${formatCurrencyShort(entity.totalObligations || 0)}</span>
                                </div>
                            </div>
                            <button class="close-btn" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                        </div>
                    </div>
                    
                    <div class="content-container">
                        <div class="section">
                            <h2 class="section-title">${entity.type?.toUpperCase() || 'Entity'} Profile</h2>
                            <div class="profile-card">
                                <div class="profile-header">
                                    <div>
                                        <h3 class="profile-title">${entity.name}</h3>
                                        <div class="profile-meta">
                                            ${entity.tier ? `<span class="tier-badge">${entity.tier}</span>` : ''}
                                        </div>
                                    </div>
                                    <div class="action-links">
                                        ${profileData.website ? `
                                        <a href="${profileData.website.startsWith('http') ? profileData.website : 'https://' + profileData.website}" 
                                           target="_blank" 
                                           rel="noopener noreferrer"
                                           class="action-link website-link">
                                            üåê Website
                                        </a>` : ''}
                                        ${profileData.linkedin ? `
                                        <a href="${profileData.linkedin.startsWith('http') ? profileData.linkedin : 'https://' + profileData.linkedin}" 
                                           target="_blank" 
                                           rel="noopener noreferrer"
                                           class="action-link linkedin-link">
                                            üíº LinkedIn
                                        </a>` : ''}
                                        <button class="action-link report-dropdown-btn" onclick="openProfileSelector()">
                                            üìÑ Get Profiles
                                        </button>
                                    </div>
                                </div>
                                <div class="overview-text">
                                    ${profileData.overview || `${entity.name} is a ${entity.type?.toLowerCase() || 'organization'} with ${formatCurrencyShort(entity.totalObligations || 0)} in total government obligations.`}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function processUSAiProfile(entity) {
            if (!entity) return { website: '', linkedin: '', overview: '' };
            
            const website = entity.website || entity.usaiProfile?.website || '';
            const linkedin = entity.linkedin || entity.usaiProfile?.linkedin || '';
            const overview = entity.usaiProfile?.overview || '';
            
            return {
                website: website,
                linkedin: linkedin,
                overview: overview
            };
        }
        
        function processEntityData(entity) {
            return {
                totalObligations: entity.totalObligations || 0
            };
        }
        
        window.openProfileSelector = function() {
            const entity = window.currentEntityData;
            if (!entity) {
                alert('No entity data available');
                return;
            }
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.6); z-index: 10000; display: flex;
                align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 0; max-width: 450px; width: 90%; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <div style="background: linear-gradient(135deg, #0a2240 0%, #144673 100%); color: white; padding: 20px 24px;">
                        <h3 style="margin: 0; font-size: 1.2rem;">üìÑ Generate Profile for ${entity.name}</h3>
                    </div>
                    <div style="padding: 24px;">
                        <p style="margin: 0 0 20px 0; color: #666;">Select a profile type:</p>
                        
                        <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 24px;">
                            <button onclick="selectProfileType('Executive Profile')" style="padding: 16px; background: #f8f9fa; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; text-align: left; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #0a2240;">üìã Executive Profile</div>
                                    <div style="font-size: 0.8rem; color: #666;">One-page summary with key metrics</div>
                                </div>
                                <span style="background: #dcfce7; color: #166534; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">READY</span>
                            </button>
                            
                            <button onclick="showComingSoon('Product Report')" style="padding: 16px; background: #fafafa; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; text-align: left; opacity: 0.7; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #0a2240;">üìä Product Report</div>
                                    <div style="font-size: 0.8rem; color: #666;">Product and service analysis</div>
                                </div>
                                <span style="background: #fef3c7; color: #92400e; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">IN DEV</span>
                            </button>
                            
                            <button onclick="showComingSoon('Contract Summary')" style="padding: 16px; background: #fafafa; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; text-align: left; opacity: 0.7; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #0a2240;">üìë Contract Summary</div>
                                    <div style="font-size: 0.8rem; color: #666;">Contract and procurement overview</div>
                                </div>
                                <span style="background: #fef3c7; color: #92400e; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">IN DEV</span>
                            </button>
                        </div>
                        
                        <div style="text-align: center;">
                            <button onclick="closeProfileModal()" style="padding: 10px 28px; background: #e5e7eb; color: #333; border: none; border-radius: 6px; cursor: pointer; font-size: 0.95rem;">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.profileModal = modal;
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeProfileModal();
            });
        };
        
        window.closeProfileModal = function() {
            if (window.profileModal) {
                window.profileModal.remove();
                window.profileModal = null;
            }
        };
        
        window.selectProfileType = function(profileType) {
            closeProfileModal();
            
            if (profileType === 'Executive Profile') {
                // Show letterhead selection modal
                showLetterheadSelection(profileType);
            } else {
                showComingSoon(profileType);
            }
        };
        
        window.showComingSoon = function(profileType) {
            closeProfileModal();
            alert(`${profileType} is coming soon!\n\nThis profile type is currently in development.`);
        };
        
        // Show letterhead selection modal
        window.showLetterheadSelection = function(profileType) {
            const entity = window.currentEntityData;
            if (!entity) {
                alert('No entity data available');
                return;
            }
            
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10001; animation: fadeIn 0.2s;';
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 0; max-width: 450px; width: 90%; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <div style="background: linear-gradient(135deg, #0a2240 0%, #144673 100%); color: white; padding: 20px 24px;">
                        <h3 style="margin: 0; font-size: 1.2rem;">üé® Select Letterhead</h3>
                    </div>
                    <div style="padding: 24px;">
                        <p style="margin: 0 0 20px 0; color: #666;">Choose letterhead for ${profileType}:</p>
                        
                        <div style="display: flex; gap: 12px; margin-bottom: 24px;">
                            <button onclick="generateProfile('${profileType}', 'GSA')" style="flex: 1; padding: 20px; background: #0a2240; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s;" onmouseover="this.style.background='#144673'" onmouseout="this.style.background='#0a2240'">
                                GSA
                                <div style="font-size: 0.75rem; font-weight: 400; margin-top: 4px;">General Services Admin</div>
                            </button>
                            <button onclick="generateProfile('${profileType}', 'ITVMO')" style="flex: 1; padding: 20px; background: #1a472a; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s;" onmouseover="this.style.background='#2e5a3e'" onmouseout="this.style.background='#1a472a'">
                                ITVMO
                                <div style="font-size: 0.75rem; font-weight: 400; margin-top: 4px;">IT Vendor Management</div>
                            </button>
                        </div>
                        
                        <div style="text-align: center;">
                            <button onclick="closeLetterheadModal()" style="padding: 10px 28px; background: #e5e7eb; color: #333; border: none; border-radius: 6px; cursor: pointer; font-size: 0.95rem;">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.letterheadModal = modal;
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeLetterheadModal();
            });
        };
        
        // Close letterhead modal
        window.closeLetterheadModal = function() {
            if (window.letterheadModal) {
                window.letterheadModal.remove();
                window.letterheadModal = null;
            }
        };
        
        // Check if google.script.run exists
        window.checkGoogleScriptRun = function() {
            console.log('Checking google.script.run...');
            console.log('typeof google:', typeof window.google);
            console.log('google exists:', !!window.google);
            console.log('google.script exists:', !!window.google?.script);
            console.log('google.script.run exists:', !!window.google?.script?.run);
            console.log('Window location:', window.location.href);
            console.log('Parent window:', window.parent !== window);
            
            if (!window.google?.script?.run) {
                alert('‚ùå google.script.run is not available in this context!\nLocation: ' + window.location.href);
                return false;
            } else {
                alert('‚úÖ google.script.run is available!');
                return true;
            }
        };

        // Simple test function
        window.testSimple = function() {
            console.log('Testing simple function...');
            
            if (!window.checkGoogleScriptRun()) {
                return;
            }
            
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('‚úÖ Simple test SUCCESS:', result);
                    alert('Simple test worked! Result: ' + result);
                })
                .withFailureHandler(function(error) {
                    console.error('‚ùå Simple test FAILED:', error);
                    alert('Simple test failed: ' + error.message);
                })
                .testSimple();
        };

        // Minimal HTML test
        window.testMinimal = function() {
            console.log('Testing minimal HTML...');
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('‚úÖ Minimal HTML test SUCCESS:', result);
                    if (result && result.html) {
                        alert('Minimal HTML test worked! HTML length: ' + result.html.length);
                    } else {
                        alert('Minimal HTML test failed: no HTML returned');
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('‚ùå Minimal HTML test FAILED:', error);
                    alert('Minimal HTML test failed: ' + error.message);
                })
                .testMinimalHTML();
        };

        // Test function
        window.testProfile = function() {
            console.log('Testing profile generation...');
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('Test success:', result);
                    if (result && result.html) {
                        // Show in simple modal
                        const modal = document.createElement('div');
                        modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';
                        modal.innerHTML = `
                            <div style="background: white; padding: 20px; border-radius: 8px; max-width: 500px;">
                                ${result.html}
                                <button onclick="this.closest('[style*=fixed]').remove()" style="margin-top: 15px; padding: 5px 15px; background: #dc3545; color: white; border: none; border-radius: 4px;">Close</button>
                            </div>
                        `;
                        document.body.appendChild(modal);
                    } else {
                        alert('Test failed: no HTML returned');
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Test failed:', error);
                    alert('Test failed: ' + error.message);
                })
                .testProfileGeneration();
        };

        // Generate profile function
        window.generateProfile = function(profileType, letterhead) {
            closeLetterheadModal();
            
            const entity = window.currentEntityData;
            if (!entity) {
                alert('No entity data available');
                return;
            }
            
            // Show loading indicator
            const loadingModal = document.createElement('div');
            loadingModal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10002;';
            loadingModal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 2rem; margin-bottom: 10px;">‚è≥</div>
                    <div style="color: #333; font-weight: 600;">Generating ${profileType}...</div>
                    <div style="color: #666; font-size: 0.9rem; margin-top: 5px;">Please wait</div>
                    <button onclick="checkGoogleScriptRun()" style="margin-top: 15px; padding: 5px 15px; background: #ffc107; color: black; border: none; border-radius: 4px;">Check API</button>
                    <button onclick="testSimple()" style="margin-top: 15px; padding: 5px 15px; background: #28a745; color: white; border: none; border-radius: 4px;">Test Simple</button>
                    <button onclick="testMinimal()" style="margin-top: 15px; padding: 5px 15px; background: #17a2b8; color: white; border: none; border-radius: 4px;">Test HTML</button>
                    <button onclick="testProfile()" style="margin-top: 15px; padding: 5px 15px; background: #007bff; color: white; border: none; border-radius: 4px;">Test Full</button>
                </div>
            `;
            document.body.appendChild(loadingModal);
            
            // Call backend to generate profile
            console.log('Calling backend with entity:', entity.name, 'letterhead:', letterhead);
            
            google.script.run
                .withSuccessHandler(function(result) {
                    loadingModal.remove();
                    console.log('‚úÖ Success handler called');
                    console.log('Full result object:', result);
                    console.log('Result type:', typeof result);
                    console.log('Result keys:', result ? Object.keys(result) : 'null');
                    console.log('Result.success:', result?.success);
                    console.log('Result.html exists:', !!result?.html);
                    console.log('HTML length:', result?.html ? result.html.length : 0);
                    console.log('First 200 chars of HTML:', result?.html ? result.html.substring(0, 200) : 'no html');
                    
                    if (!result) {
                        alert('No response from server');
                        return;
                    }
                    
                    if (result.error) {
                        alert('Error: ' + result.error);
                        return;
                    }
                    
                    if (result.html) {
                        console.log('Attempting to display HTML...');
                        
                        // Try method 1: Direct write to new window
                        try {
                            const newWindow = window.open('about:blank', '_blank');
                            if (newWindow) {
                                newWindow.document.open();
                                newWindow.document.write(result.html);
                                newWindow.document.close();
                                console.log('‚úÖ HTML written to new window');
                            } else {
                                throw new Error('Popup blocked');
                            }
                        } catch (e) {
                            console.error('Failed to open new window:', e);
                            
                            // Method 2: Show in iframe modal
                            const modal = document.createElement('div');
                            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';
                            
                            const container = document.createElement('div');
                            container.style.cssText = 'width: 90%; max-width: 1200px; height: 90vh; background: white; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column;';
                            
                            const header = document.createElement('div');
                            header.style.cssText = 'padding: 15px; background: #f8f9fa; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center;';
                            header.innerHTML = `
                                <h3 style="margin: 0;">Executive Profile - ${entity.name}</h3>
                                <button onclick="this.closest('[style*=fixed]').remove()" style="background: #dc3545; color: white; border: none; padding: 5px 15px; border-radius: 4px; cursor: pointer;">Close</button>
                            `;
                            
                            const iframe = document.createElement('iframe');
                            iframe.style.cssText = 'flex: 1; width: 100%; border: none;';
                            iframe.srcdoc = result.html;
                            
                            container.appendChild(header);
                            container.appendChild(iframe);
                            modal.appendChild(container);
                            document.body.appendChild(modal);
                            
                            console.log('‚úÖ HTML displayed in modal iframe');
                        }
                    } else {
                        console.error('No HTML in result');
                        alert('No HTML content generated. Check console for details.');
                    }
                })
                .withFailureHandler(function(error) {
                    loadingModal.remove();
                    alert('Error: ' + error.message);
                })
                .generateExecutiveProfileDirect(entity, letterhead);
        };
        
        // Show profile preview
        window.showProfilePreview = function(html, profileType, letterhead) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 10002; padding: 20px;';
            
            const container = document.createElement('div');
            container.style.cssText = 'background: white; width: 100%; max-width: 900px; height: 90vh; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column;';
            
            container.innerHTML = `
                <div style="background: linear-gradient(135deg, #0a2240 0%, #144673 100%); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0; font-size: 1.1rem;">${profileType} Preview - ${letterhead}</h3>
                    <button onclick="closePreviewModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer;">‚úï Close</button>
                </div>
                <div style="flex: 1; overflow: auto; padding: 20px;">
                    ${html}
                </div>
                <div style="padding: 15px; background: #f8f9fa; border-top: 1px solid #dee2e6; text-align: center;">
                    <button onclick="generateFinalDocument('${profileType}', '${letterhead}')" style="background: #f47920; color: white; border: none; padding: 10px 30px; border-radius: 6px; font-size: 1rem; font-weight: 600; cursor: pointer;">üìÑ Generate Document</button>
                </div>
            `;
            
            modal.appendChild(container);
            document.body.appendChild(modal);
            window.previewModal = modal;
        };
        
        // Close preview modal
        window.closePreviewModal = function() {
            if (window.previewModal) {
                window.previewModal.remove();
                window.previewModal = null;
            }
        };
        
        // Generate final document
        window.generateFinalDocument = function(profileType, letterhead) {
            closePreviewModal();
            generateProfile(profileType, letterhead);
        };
        
        // Make showEntityDetail available to React
        const showEntityDetail = window.showEntityDetail;
        
        console.log('‚úÖ Entity detail functions loaded in React:');
        console.log('  - showEntityDetail:', typeof window.showEntityDetail);
        console.log('  - openProfileSelector:', typeof window.openProfileSelector);
        console.log('  - closeProfileModal:', typeof window.closeProfileModal);
        console.log('  - selectProfileType:', typeof window.selectProfileType);
        console.log('  - showComingSoon:', typeof window.showComingSoon);

        // Global entities storage
        let currentEntities = [];
        
        // Main Dashboard Component
        const DashboardApp = () => {
            const [entities, setEntities] = useState([]);
            const [filteredEntities, setFilteredEntities] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [filters, setFilters] = useState({
                type: '',
                search: '',
                minObligation: '',
                maxObligation: ''
            });

            // Load initial data
            useEffect(() => {
                loadEntities();
            }, []);

            // Apply filters when they change
            useEffect(() => {
                applyFilters();
            }, [entities, filters]);

            const loadEntities = async () => {
                setLoading(true);
                setError('');
                try {
                    const data = await callGoogleScript('getAllEntities');
                    if (data && Array.isArray(data)) {
                        setEntities(data);
                        currentEntities = data;
                    } else {
                        setError('No entity data available');
                    }
                } catch (err) {
                    console.error('Error loading entities:', err);
                    setError('Failed to load entity data: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            const applyFilters = () => {
                let filtered = [...entities];

                // Type filter
                if (filters.type) {
                    filtered = filtered.filter(entity => 
                        entity.type && entity.type.toLowerCase().includes(filters.type.toLowerCase())
                    );
                }

                // Search filter
                if (filters.search) {
                    filtered = filtered.filter(entity =>
                        entity.name && entity.name.toLowerCase().includes(filters.search.toLowerCase())
                    );
                }

                // Obligation range filters
                if (filters.minObligation) {
                    const min = parseFloat(filters.minObligation);
                    filtered = filtered.filter(entity => 
                        entity.totalObligations && entity.totalObligations >= min
                    );
                }

                if (filters.maxObligation) {
                    const max = parseFloat(filters.maxObligation);
                    filtered = filtered.filter(entity => 
                        entity.totalObligations && entity.totalObligations <= max
                    );
                }

                setFilteredEntities(filtered);
            };

            const updateFilter = (key, value) => {
                setFilters(prev => ({ ...prev, [key]: value }));
            };

            const openEntityDetail = (entityIndex) => {
                const entity = filteredEntities[entityIndex];
                if (!entity) return;

                // Import and use the entity detail modal
                showEntityDetail(entity, entityIndex);
            };

            return (
                <>
                    {/* Control Panel */}
                    <div className="control-panel">
                        <div className="control-row">
                            <div className="control-group">
                                <label className="control-label">Entity Type</label>
                                <select 
                                    className="control-input"
                                    value={filters.type}
                                    onChange={(e) => updateFilter('type', e.target.value)}
                                >
                                    <option value="">All Types</option>
                                    <option value="agency">Agency</option>
                                    <option value="oem">OEM</option>
                                    <option value="vendor">Vendor</option>
                                </select>
                            </div>

                            <div className="control-group">
                                <label className="control-label">Search</label>
                                <input 
                                    type="text"
                                    className="control-input"
                                    placeholder="Search entities..."
                                    value={filters.search}
                                    onChange={(e) => updateFilter('search', e.target.value)}
                                />
                            </div>

                            <div className="control-group">
                                <label className="control-label">Min Obligation ($M)</label>
                                <input 
                                    type="number"
                                    className="control-input"
                                    placeholder="0"
                                    value={filters.minObligation}
                                    onChange={(e) => updateFilter('minObligation', e.target.value)}
                                />
                            </div>

                            <div className="control-group">
                                <label className="control-label">Max Obligation ($M)</label>
                                <input 
                                    type="number"
                                    className="control-input"
                                    placeholder="1000"
                                    value={filters.maxObligation}
                                    onChange={(e) => updateFilter('maxObligation', e.target.value)}
                                />
                            </div>

                            <button className="btn btn-primary" onClick={loadEntities}>
                                üîÑ Refresh Data
                            </button>
                        </div>
                    </div>

                    {/* Entities Section */}
                    <div className="entities-container">
                        <div className="entities-header">
                            <h2 className="entities-title">Government Technology Entities</h2>
                            <div className="entities-count">
                                Showing {filteredEntities.length} of {entities.length} entities
                            </div>
                        </div>

                        {loading && (
                            <div className="loading">
                                ‚è≥ Loading entities...
                            </div>
                        )}

                        {error && (
                            <div className="error">
                                {error}
                            </div>
                        )}

                        {!loading && !error && (
                            <div className="entities-grid">
                                {filteredEntities.map((entity, index) => (
                                    <div 
                                        key={entity.name || index}
                                        className="entity-card"
                                        onClick={() => openEntityDetail(index)}
                                    >
                                        <div className="entity-name">{entity.name || 'Unknown Entity'}</div>
                                        <div className="entity-type">
                                            {entity.type?.toUpperCase() || 'ENTITY'}
                                        </div>
                                        
                                        <div className="entity-stats">
                                            <div className="stat">
                                                <div className="stat-value">
                                                    {formatCurrencyShort(entity.totalObligations || 0)}
                                                </div>
                                                <div className="stat-label">Total Obligations</div>
                                            </div>
                                            <div className="stat">
                                                <div className="stat-value">
                                                    {entity.contractCount || 0}
                                                </div>
                                                <div className="stat-label">Contracts</div>
                                            </div>
                                        </div>
                                        
                                        {entity.tier && (
                                            <div style={{ 
                                                marginTop: '0.5rem', 
                                                padding: '0.25rem 0.5rem', 
                                                background: 'var(--green)', 
                                                color: 'white', 
                                                borderRadius: '4px', 
                                                fontSize: '0.8rem', 
                                                textAlign: 'center',
                                                fontWeight: '600'
                                            }}>
                                                {entity.tier}
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}

                        {!loading && !error && filteredEntities.length === 0 && (
                            <div className="loading">
                                No entities found matching your criteria
                            </div>
                        )}
                    </div>
                </>
            );
        };

        // Utility function for API calls
        const callGoogleScript = (functionName, ...params) => {
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(reject)
                    [functionName](...params);
            });
        };

        // Open report builder function
        const openReportBuilder = () => {
            try {
                // Log access to Report Generator
                google.script.run.logReportGeneratorAccess();
                
                google.script.run
                    .withSuccessHandler((url) => {
                        if (url) {
                            window.location.href = url;
                        } else {
                            console.error('Failed to get Report Builder URL');
                            alert('Unable to open Report Builder. Please try again.');
                        }
                    })
                    .withFailureHandler((error) => {
                        console.error('Error opening Report Builder:', error);
                        alert('Error opening Report Builder: ' + error.message);
                    })
                    .getReportBuilderUrl();
            } catch (error) {
                console.error('Error in openReportBuilder:', error);
                alert('Error opening Report Builder. Please try again.');
            }
        };

        // Log dashboard access when page loads
        if (window.google?.script?.run) {
            google.script.run
                .withSuccessHandler((result) => {
                    // Silent success
                })
                .withFailureHandler((error) => {
                    console.error('Dashboard access logging failed:', error);
                })
                .logAppAccess();
        }
        
        // Add test button for debugging
        window.testAccessLogging = function() {
            console.log('üß™ Testing access logging...');
            google.script.run
                .withSuccessHandler((result) => {
                    console.log('‚úÖ Test result:', result);
                    alert(`Test ${result.success ? 'succeeded' : 'failed'}: ${result.message}`);
                })
                .withFailureHandler((error) => {
                    console.error('‚ùå Test failed:', error);
                    alert('Test failed: ' + error.toString());
                })
                .testLogFromClient();
        };
        
        // SIMPLE TEST - Test basic web->Apps Script communication
        window.simpleTest = function() {
            alert('Testing web->script communication...');
            
            // Test 1: Basic communication
            google.script.run
                .withSuccessHandler((result) => {
                    alert('SUCCESS: ' + result);
                    
                    // Test 2: Try to log to sheet
                    google.script.run
                        .withSuccessHandler((logResult) => {
                            alert('LOG RESULT: ' + logResult);
                        })
                        .withFailureHandler((logError) => {
                            alert('LOG ERROR: ' + logError.toString());
                        })
                        .simpleWebLogTest();
                })
                .withFailureHandler((error) => {
                    alert('COMMUNICATION ERROR: ' + error.toString());
                })
                .alertTest();
        };

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('dashboardApp'));
        root.render(<DashboardApp />);
    </script>
</body>
</html>