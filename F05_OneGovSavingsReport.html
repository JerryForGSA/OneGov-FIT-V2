<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OneGov Savings Report Viewer</title>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- html2canvas for chart export -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  
  <style>
    :root {
      --primary-dark: #0a2240;
      --primary: #144673;
      --primary-light: #3a6ea5;
      --accent: #f47920;
      --accent-light: #ff8c42;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-600: #4b5563;
      --gray-800: #1f2937;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--gray-100);
      color: var(--gray-800);
      line-height: 1.5;
    }
    
    /* Header */
    .header {
      background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
      color: white;
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .header h1 { font-size: 24px; font-weight: 600; }
    .header-actions { display: flex; gap: 12px; flex-wrap: wrap; }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { background: var(--accent-light); }
    .btn-secondary { background: white; color: var(--primary); border: 1px solid var(--gray-300); }
    .btn-secondary:hover { background: var(--gray-100); }
    .btn-success { background: var(--success); color: white; }
    .btn-success:hover { background: #16a34a; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-danger:hover { background: #dc2626; }
    .btn-warning { background: var(--warning); color: white; }
    .btn-warning:hover { background: #d97706; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    /* Report Selector */
    .report-selector {
      background: white;
      padding: 20px 30px;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 20px;
    }
    
    .selector-group { display: flex; align-items: center; gap: 10px; }
    .selector-group label { font-weight: 500; color: var(--gray-600); white-space: nowrap; }
    .selector-group select {
      padding: 10px 15px;
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      font-size: 14px;
      min-width: 300px;
      background: white;
    }
    .selector-group select:disabled { background: var(--gray-100); cursor: not-allowed; }
    
    .report-count {
      font-size: 13px;
      color: var(--gray-600);
      padding: 6px 12px;
      background: var(--gray-100);
      border-radius: 20px;
    }
    
    /* Status Badge */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
    }
    .status-badge.under-review { background: #fef3c7; color: #92400e; }
    .status-badge.approved { background: #dcfce7; color: #166534; }
    
    /* Review Panel */
    .review-panel {
      background: #fef3c7;
      border: 1px solid #fbbf24;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 24px;
    }
    .review-panel.approved { background: #dcfce7; border-color: #22c55e; }
    .review-panel h3 { margin-bottom: 12px; color: var(--primary-dark); }
    
    .review-actions { display: flex; gap: 12px; margin-top: 16px; flex-wrap: wrap; }
    
    .review-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    
    .review-item { display: flex; align-items: center; gap: 8px; }
    .review-item .icon { font-size: 18px; }
    .review-item.pending .icon { color: var(--warning); }
    .review-item.complete .icon { color: var(--success); }
    
    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 30px;
      max-width: 500px;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    }
    
    .modal-icon { font-size: 48px; margin-bottom: 16px; }
    .modal-title { font-size: 20px; font-weight: 600; margin-bottom: 12px; color: var(--primary-dark); }
    .modal-message { color: var(--gray-600); margin-bottom: 20px; }
    
    .rejection-modal textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      font-family: inherit;
      font-size: 14px;
      margin-bottom: 16px;
    }
    
    .modal-actions { display: flex; gap: 12px; justify-content: flex-end; }
    
    /* Main Content */
    .main-content { max-width: 1200px; margin: 30px auto; padding: 0 30px; }
    
    /* Cards */
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 24px;
      overflow: hidden;
    }
    
    .card-header {
      padding: 16px 24px;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .card-header h2 { font-size: 18px; color: var(--primary-dark); }
    .card-body { padding: 24px; }
    
    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .stat-item { text-align: center; }
    .stat-value { font-size: 24px; font-weight: 700; color: var(--primary-dark); }
    .stat-value.highlight { color: var(--success); }
    .stat-label { font-size: 13px; color: var(--gray-600); margin-top: 4px; }
    
    /* Charts */
    .chart-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 24px;
    }
    
    .chart-container { height: 350px; position: relative; }
    .chart-container-small { height: 200px; position: relative; }
    
    /* Gauge Section */
    .gauge-section { margin-top: 24px; }
    .gauge-section h3 { 
      font-size: 16px; 
      color: var(--primary-dark); 
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--accent);
    }
    
    .gauge-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }
    
    .gauge-card {
      background: var(--gray-50);
      border-radius: 8px;
      padding: 16px;
      border: 1px solid var(--gray-200);
    }
    
    .gauge-card h4 {
      font-size: 14px;
      color: var(--primary-dark);
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .gauge-card .percentage {
      font-size: 16px;
      font-weight: 700;
      color: var(--success);
    }
    
    .gauge-bar-container {
      background: var(--gray-200);
      border-radius: 4px;
      height: 24px;
      overflow: hidden;
      margin-bottom: 12px;
    }
    
    .gauge-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--success) 0%, #16a34a 100%);
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    
    .gauge-details {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      font-size: 12px;
      color: var(--gray-600);
    }
    
    .gauge-details .detail-item { text-align: center; }
    .gauge-details .detail-value { 
      font-weight: 600; 
      color: var(--primary-dark);
      display: block;
    }
    
    /* Tables */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    
    .data-table th, .data-table td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--gray-200);
    }
    
    .data-table th {
      background: var(--gray-50);
      font-weight: 600;
      color: var(--gray-600);
    }
    
    .data-table td.numeric { text-align: right; font-family: 'Monaco', monospace; }
    .data-table tr:hover { background: var(--gray-50); }
    
    /* Commentary */
    .commentary-section {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--gray-200);
    }
    
    .commentary-label {
      font-size: 13px;
      font-weight: 500;
      color: var(--gray-600);
      margin-bottom: 8px;
    }
    
    .commentary-textarea {
      width: 100%;
      min-height: 80px;
      padding: 12px;
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
    }
    
    /* Loading State */
    .loading-container {
      text-align: center;
      padding: 60px 20px;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid var(--gray-200);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--gray-600);
    }
    
    .empty-state-icon { font-size: 48px; margin-bottom: 16px; }
    /* OneGov FIT Loading Overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #0a2240 0%, #144673 50%, #3a6ea5 100%);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        opacity: 0;
        animation: fadeInOverlay 0.5s ease-out forwards;
    }

    .loading-content {
        text-align: center;
        color: white;
        position: relative;
    }

    .loading-logo {
        margin-bottom: 2rem;
    }

    .logo-circle {
        width: 120px;
        height: 120px;
        background: rgba(255, 255, 255, 0.1);
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
        animation: logoFloat 3s ease-in-out infinite;
    }

    .logo-text {
        font-size: 1.5rem;
        font-weight: 700;
        letter-spacing: 1px;
        color: #f47920;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .logo-subtext {
        font-size: 0.9rem;
        font-weight: 600;
        letter-spacing: 2px;
        color: rgba(255, 255, 255, 0.9);
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(255, 255, 255, 0.2);
        border-top: 3px solid #f47920;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1.5rem;
    }

    .loading-message {
        font-size: 1.1rem;
        font-weight: 500;
        margin-bottom: 1rem;
        min-height: 1.5rem;
        animation: messageGlow 2s ease-in-out infinite alternate;
    }

    .loading-progress {
        width: 300px;
        height: 4px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 2px;
        margin: 1rem auto;
        overflow: hidden;
    }

    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #f47920, #ff8c42);
        border-radius: 2px;
        width: 0%;
        transition: width 0.3s ease;
    }

    .loading-subtitle {
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.7);
        margin-top: 1rem;
        font-weight: 300;
        letter-spacing: 0.5px;
    }

    .loading-powered-by {
        margin-top: 2rem;
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .usai-badge {
        background: linear-gradient(45deg, #f47920, #ff8c42);
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-weight: 700;
        font-size: 0.8rem;
        letter-spacing: 0.5px;
    }

    .flag {
        font-size: 1rem;
    }

    @keyframes fadeInOverlay {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes logoFloat {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @keyframes messageGlow {
        0% { opacity: 0.8; }
        100% { opacity: 1; }
    }
  </style>
</head>
<body>
  <!-- OneGov FIT Loading Overlay -->
  <div id="oneGovLoadingOverlay" class="loading-overlay" style="display: none;">
      <div class="loading-content">
          <div class="loading-logo">
              <div class="logo-circle">
                  <span class="logo-text">OneGov</span>
                  <span class="logo-subtext">FIT</span>
              </div>
          </div>
          <div class="loading-spinner"></div>
          <div class="loading-message" id="loadingMessage">Loading savings reports...</div>
          <div class="loading-progress">
              <div class="progress-bar" id="progressBar"></div>
          </div>
          <div class="loading-subtitle">Federal Information Technology Market Intelligence</div>
          <div class="loading-powered-by">
              <span>Powered by</span>
              <span class="usai-badge">USAi</span>
              <span class="flag"></span>
          </div>
      </div>
  </div>

  <!-- Header -->
  <div class="header">
    <h1>üìä OneGov Savings Report Viewer</h1>
    <div class="header-actions">
      <button class="btn btn-secondary" onclick="refreshReports()">üîÑ Refresh</button>
      <button class="btn btn-primary" onclick="viewDocument()" id="viewDocBtn" style="display:none;">üìÑ View Document</button>
      <button class="btn btn-warning" onclick="openDocument()" id="editDocBtn" style="display:none;">üìù Edit Document</button>
      <button class="btn btn-primary" onclick="saveCommentary()">üíæ Save Commentary</button>
    </div>
  </div>
  
  <!-- Report Selector -->
  <div class="report-selector">
    <div class="selector-group">
      <label for="reportSelect">Select Report:</label>
      <select id="reportSelect" onchange="loadSelectedReport()">
        <option value="">-- Select a Report --</option>
      </select>
    </div>
    <span class="report-count" id="reportCount">0 reports</span>
  </div>
  
  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <div class="empty-state">
      <div class="empty-state-icon">üìã</div>
      <p>Select a report from the dropdown above to view details.</p>
    </div>
  </div>
  
  <!-- Modal Container -->
  <div id="modalContainer"></div>
  
  <script>
    // OneGov FIT Loading Manager
    const LoadingManager = {
        startTime: null,
        estimatedDuration: 3000,
        progressInterval: null,
        context: 'data', // 'init', 'entity', 'view', 'data'

        show: function(message, estimatedMs = 3000, context = 'data') {
            this.context = context;
            this.startTime = Date.now();
            this.estimatedDuration = estimatedMs;

            const overlay = document.getElementById('oneGovLoadingOverlay');
            const messageEl = document.getElementById('loadingMessage');
            const progressBar = document.getElementById('progressBar');

            if (overlay) {
                overlay.style.display = 'flex';
                messageEl.textContent = message || 'Processing...';
                progressBar.style.width = '0%';

                // Context-specific progress messages
                const progressMessages = {
                    init: ['Initializing system...', 'Loading configurations...', 'Connecting to database...', 'Preparing interface...'],
                    entity: ['Loading entity data...', 'Fetching relationships...', 'Building visualizations...', 'Rendering charts...'],
                    view: ['Switching view...', 'Loading components...', 'Preparing layout...', 'Finalizing display...'],
                    data: ['Connecting to database...', 'Fetching reports...', 'Processing data...', 'Rendering visualizations...']
                };

                const messages = progressMessages[context] || progressMessages.data;
                let messageIndex = 0;

                this.progressInterval = setInterval(() => {
                    const elapsed = Date.now() - this.startTime;
                    const progress = Math.min((elapsed / this.estimatedDuration) * 100, 95);
                    progressBar.style.width = progress + '%';

                    // Update message every 25% progress
                    const newMessageIndex = Math.floor(progress / 25);
                    if (newMessageIndex !== messageIndex && newMessageIndex < messages.length) {
                        messageIndex = newMessageIndex;
                        messageEl.textContent = messages[messageIndex];
                    }

                    if (progress >= 95) {
                        clearInterval(this.progressInterval);
                    }
                }, 100);
            }
        },

        hide: function() {
            const overlay = document.getElementById('oneGovLoadingOverlay');
            const progressBar = document.getElementById('progressBar');
            
            if (overlay && this.progressInterval) {
                // Complete the progress bar
                progressBar.style.width = '100%';
                
                setTimeout(() => {
                    overlay.style.display = 'none';
                    progressBar.style.width = '0%';
                    clearInterval(this.progressInterval);
                    this.progressInterval = null;
                }, 200);
            }
        }
    };

    // Global navigation function with loading
    function navigateWithLoading(url, loadingMessage = 'Loading...', context = 'view') {
        LoadingManager.show(loadingMessage, 2000, context);
        
        setTimeout(() => {
            window.location.href = url;
        }, 300);
    }

    // Global state
    let allReports = [];
    let currentReport = null;
    let currentRowNum = null;
    let currentDriveUrl = null;
    let currentReviewStatus = null;
    let currentAccess = null;
    let chart1Instance = null;
    let chart2Instance = null;
    let chart3Instance = null;
    let overallGaugeChart = null;
    let oemGaugeCharts = [];
    
    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
      // Show initialization loading
      LoadingManager.show('Loading Savings Report View...', 1500, 'view');
      
      // Log access to Reports view
      if (window.google?.script?.run) {
        google.script.run.logReportsAccess();
      }
      
      setTimeout(() => {
        LoadingManager.hide();
        loadReports();
      }, 1500);
    });
    
    // Load reports list
    function loadReports() {
      showLoading();
      
      google.script.run
        .withSuccessHandler(result => {
          if (result.error) {
            showError(result.error);
            return;
          }
          
          allReports = result.reports || [];
          populateReportDropdown();
          document.getElementById('reportCount').textContent = `${allReports.length} reports`;
          
          if (allReports.length === 0) {
            showEmptyState('No reports found. Generate a report from the spreadsheet first.');
          } else {
            showEmptyState('Select a report from the dropdown above to view details.');
          }
        })
        .withFailureHandler(err => {
          showError('Failed to load reports: ' + err.message);
        })
        .getReportsWithReviewStatus();
    }
    
    // Populate dropdown
    function populateReportDropdown() {
      const select = document.getElementById('reportSelect');
      select.innerHTML = '<option value="">-- Select a Report --</option>';
      
      allReports.forEach((report, idx) => {
        if (report.hasJson || report.driveUrl) {
          const option = document.createElement('option');
          option.value = idx;
          
          const status = report.reviewStatus?.isFullyApproved ? '‚úÖ' : 'üî∂';
          const period = report.json?.reportingPeriod || 'Unknown Period';
          const savings = report.json?.executiveSummary?.data?.totalSavingsFormatted || '$0';
          
          option.textContent = `${status} ${report.reportType || 'Report'} - ${period} (${savings})`;
          select.appendChild(option);
        }
      });
    }
    
    // Load selected report
    function loadSelectedReport() {
      const select = document.getElementById('reportSelect');
      const idx = select.value;
      
      if (idx === '') {
        showEmptyState('Select a report from the dropdown above to view details.');
        document.getElementById('viewDocBtn').style.display = 'none';
        document.getElementById('editDocBtn').style.display = 'none';
        return;
      }
      
      const report = allReports[parseInt(idx)];
      if (!report) {
        showError('Report not found');
        return;
      }
      
      currentReport = report.json;
      currentRowNum = report.rowNum;
      currentDriveUrl = report.driveUrl;
      currentReviewStatus = report.reviewStatus || { isFullyApproved: false, hasLevel1Review: false, hasLevel2Review: false };
      currentAccess = report.access || { canAccess: true, canReview: false, canEdit: false };
      
      // Always show View Document button when report is selected
      document.getElementById('viewDocBtn').style.display = 'inline-flex';
      
      // Show Edit Document only for reviewers with existing document
      if (currentDriveUrl && currentAccess.canEdit) {
        document.getElementById('editDocBtn').style.display = 'inline-flex';
      } else {
        document.getElementById('editDocBtn').style.display = 'none';
      }
      
      // Always render from JSON
      if (currentReport) {
        renderReport(currentReport, report);
      } else {
        showError('No JSON data available for this report');
      }
    }
    
    // View document - generates if needed
    function viewDocument() {
      if (!currentRowNum) {
        alert('Please select a report first');
        return;
      }
      
      if (currentDriveUrl) {
        window.open(currentDriveUrl, '_blank');
        return;
      }
      
      // Generate document
      showLoading('Generating document...');
      
      google.script.run
        .withSuccessHandler(result => {
          if (result.success) {
            currentDriveUrl = result.docUrl;
            document.getElementById('editDocBtn').style.display = 'inline-flex';
            window.open(result.docUrl, '_blank');
            loadSelectedReport(); // Refresh view
          } else {
            showError('Failed to generate document: ' + (result.error || 'Unknown error'));
          }
        })
        .withFailureHandler(err => {
          showError('Failed to generate document: ' + err.message);
        })
        .generateTDRReportDocument(currentRowNum);
    }
    
    // Open existing document for editing
    function openDocument() {
      if (currentDriveUrl) {
        window.open(currentDriveUrl, '_blank');
      } else {
        alert('No document available. Click "View Document" to generate one.');
      }
    }
    
    // Refresh reports
    function refreshReports() {
      currentReport = null;
      currentRowNum = null;
      currentDriveUrl = null;
      document.getElementById('viewDocBtn').style.display = 'none';
      document.getElementById('editDocBtn').style.display = 'none';
      loadReports();
    }
    
    // Render report view
    function renderReport(report, result) {
      const container = document.getElementById('mainContent');
      
      if (!report) {
        showError('No report data available');
        return;
      }
      
      // Use defaults if reviewStatus/access are missing
      const reviewStatus = currentReviewStatus || { isFullyApproved: false, hasLevel1Review: false, hasLevel2Review: false };
      const access = currentAccess || { canAccess: true, canReview: false, canEdit: false };
      
      const tables = report.tables || {};
      const gaugeData = report.gaugeData || report.chartData || {};
      
      // Build review panel
      let reviewPanelHTML = '';
      
      if (!reviewStatus.isFullyApproved) {
        const canApproveLevel1 = access.needsLevel1Review;
        const canApproveLevel2 = access.needsLevel2Review;
        
        reviewPanelHTML = `
          <div class="review-panel">
            <h3>üî∂ Report Under Review</h3>
            <div class="review-info">
              <div class="review-item ${reviewStatus.hasLevel1Review ? 'complete' : 'pending'}">
                <span class="icon">${reviewStatus.hasLevel1Review ? '‚úÖ' : '‚è≥'}</span>
                <span>Level 1: ${reviewStatus.level1Reviewer || 'Not assigned'}</span>
                ${reviewStatus.level1Timestamp ? `<small style="color:#666;margin-left:8px;">${new Date(reviewStatus.level1Timestamp).toLocaleString()}</small>` : ''}
              </div>
              <div class="review-item ${reviewStatus.hasLevel2Review ? 'complete' : 'pending'}">
                <span class="icon">${reviewStatus.hasLevel2Review ? '‚úÖ' : '‚è≥'}</span>
                <span>Level 2: ${reviewStatus.level2Reviewer || 'Not assigned'}</span>
                ${reviewStatus.level2Timestamp ? `<small style="color:#666;margin-left:8px;">${new Date(reviewStatus.level2Timestamp).toLocaleString()}</small>` : ''}
              </div>
            </div>
            ${access.canReview ? `
              <div class="review-actions">
                ${canApproveLevel1 ? '<button class="btn btn-success" onclick="approveLevel(1)">‚úì Approve Level 1</button>' : ''}
                ${canApproveLevel2 ? '<button class="btn btn-success" onclick="approveLevel(2)">‚úì Approve Level 2</button>' : ''}
                ${!canApproveLevel1 && !canApproveLevel2 && reviewStatus.hasLevel1Review && !access.isLevel2Reviewer ? '<span style="color:#666;">Waiting for Level 2 reviewer</span>' : ''}
                <button class="btn btn-danger" onclick="showRejectionModal()">‚úó Reject</button>
                ${currentDriveUrl ? '<button class="btn btn-warning" onclick="openDocument()">üìù Edit Document</button>' : ''}
              </div>
            ` : ''}
          </div>
        `;
      } else {
        reviewPanelHTML = `
          <div class="review-panel approved">
            <h3>‚úÖ Report Approved</h3>
            <div class="review-info">
              <div class="review-item complete">
                <span class="icon">‚úÖ</span>
                <span>Level 1: ${reviewStatus.level1Reviewer}</span>
                <small style="color:#666;margin-left:8px;">${new Date(reviewStatus.level1Timestamp).toLocaleString()}</small>
              </div>
              <div class="review-item complete">
                <span class="icon">‚úÖ</span>
                <span>Level 2: ${reviewStatus.level2Reviewer}</span>
                <small style="color:#666;margin-left:8px;">${new Date(reviewStatus.level2Timestamp).toLocaleString()}</small>
              </div>
            </div>
          </div>
        `;
      }
      
      // Build OEM gauges HTML
      const oemGauges = gaugeData.byOEM || gaugeData.oemGauges || [];
      const overallGauge = gaugeData.overall || gaugeData.overallGauge || {};
      
      let oemGaugesHTML = '';
      if (oemGauges.length > 0) {
        oemGaugesHTML = `
          <div class="gauge-section">
            <h3>OEM Savings Realization</h3>
            <div class="gauge-grid">
              ${oemGauges.map((oem, idx) => `
                <div class="gauge-card">
                  <h4>
                    ${oem.name}
                    <span class="percentage">${oem.percentageFormatted || (oem.percentage ? oem.percentage.toFixed(1) + '%' : 'N/A')}</span>
                  </h4>
                  <div class="gauge-bar-container">
                    <div class="gauge-bar" style="width: ${Math.min(100, oem.percentage || 0)}%"></div>
                  </div>
                  <div class="gauge-details">
                    <div class="detail-item">
                      <span class="detail-value">${oem.realizedFormatted || formatCurrency(oem.realized)}</span>
                      Realized
                    </div>
                    <div class="detail-item">
                      <span class="detail-value">${oem.potentialFormatted || formatCurrency(oem.potential)}</span>
                      Potential (CPL)
                    </div>
                    <div class="detail-item">
                      <span class="detail-value">${oem.transactions || 0}</span>
                      Transactions
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }
      
      container.innerHTML = `
        ${reviewPanelHTML}
        
        <!-- Executive Summary -->
        <div class="card">
          <div class="card-header">
            <h2>Executive Summary</h2>
            <span class="status-badge ${reviewStatus.isFullyApproved ? 'approved' : 'under-review'}">
              ${reviewStatus.isFullyApproved ? '‚úÖ Approved' : 'üî∂ Under Review'}
            </span>
          </div>
          <div class="card-body">
            <div class="stats-grid">
              <div class="stat-item">
                <div class="stat-value highlight">${report.executiveSummary?.data?.totalSavingsFormatted || '$0'}</div>
                <div class="stat-label">Total Savings</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${report.executiveSummary?.data?.totalTransactions || 0}</div>
                <div class="stat-label">Transactions</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${report.executiveSummary?.data?.overallDiscountRate || '0%'}</div>
                <div class="stat-label">Discount Rate</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${report.executiveSummary?.data?.oemCount || 0}</div>
                <div class="stat-label">OEMs</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${report.executiveSummary?.data?.vendorCount || 0}</div>
                <div class="stat-label">Vendors</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${report.executiveSummary?.data?.fundingDeptCount || 0}</div>
                <div class="stat-label">Departments</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${report.executiveSummary?.data?.topOEM || 'N/A'}</div>
                <div class="stat-label">Top OEM (${report.executiveSummary?.data?.topOEMPercent || 0}%)</div>
              </div>
            </div>
            
            <div class="commentary-section">
              <div class="commentary-label">Executive Summary Commentary</div>
              <textarea class="commentary-textarea" id="executiveSummaryCommentary" 
                placeholder="Add executive summary commentary...">${report.executiveSummary?.commentary || ''}</textarea>
            </div>
          </div>
        </div>
        
        <!-- Overall Program Gauge -->
        ${overallGauge.realized ? `
        <div class="card">
          <div class="card-header"><h2>Overall Program Performance</h2></div>
          <div class="card-body">
            <div class="stats-grid" style="margin-bottom: 24px;">
              <div class="stat-item">
                <div class="stat-value highlight">${overallGauge.realizedFormatted || formatCurrency(overallGauge.realized)}</div>
                <div class="stat-label">Realized Savings</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${overallGauge.potentialFormatted || formatCurrency(overallGauge.potential)}</div>
                <div class="stat-label">Potential (CPL)</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${overallGauge.percentageFormatted || (overallGauge.percentage ? overallGauge.percentage.toFixed(2) + '%' : 'N/A')}</div>
                <div class="stat-label">Realization Rate</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${overallGauge.discountRateFormatted || overallGauge.discountRate || 'N/A'}</div>
                <div class="stat-label">Overall Discount Rate</div>
              </div>
            </div>
            
            <div style="max-width: 600px; margin: 0 auto;">
              <div class="gauge-bar-container" style="height: 32px;">
                <div class="gauge-bar" style="width: ${Math.min(100, overallGauge.percentage || 0)}%"></div>
              </div>
              <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--gray-600); margin-top: 4px;">
                <span>0%</span>
                <span>Savings Realization: ${overallGauge.percentageFormatted || '0%'}</span>
                <span>100%</span>
              </div>
            </div>
            
            <div class="commentary-section">
              <div class="commentary-label">Overall Gauge Commentary</div>
              <textarea class="commentary-textarea" id="overallGaugeCommentary" 
                placeholder="Add commentary on overall program performance...">${overallGauge.commentary || ''}</textarea>
            </div>
          </div>
        </div>
        ` : ''}
        
        <!-- OEM Gauges Section -->
        ${oemGaugesHTML ? `
        <div class="card">
          <div class="card-header"><h2>OEM Performance Gauges</h2></div>
          <div class="card-body">
            ${oemGaugesHTML}
            
            <div class="commentary-section">
              <div class="commentary-label">OEM Performance Commentary</div>
              <textarea class="commentary-textarea" id="oemGaugesCommentary" 
                placeholder="Add commentary on OEM performance...">${report.financialOverview?.commentary || ''}</textarea>
            </div>
          </div>
        </div>
        ` : ''}
        
        <!-- Charts -->
        <div class="card">
          <div class="card-header"><h2>Financial Overview - Charts</h2></div>
          <div class="card-body">
            <div class="chart-row">
              <div>
                <h3 style="margin-bottom: 12px; color: var(--primary-dark);">Savings by OEM (Stacked by Month)</h3>
                <div class="chart-container"><canvas id="chart1"></canvas></div>
              </div>
              <div>
                <h3 style="margin-bottom: 12px; color: var(--primary-dark);">Monthly Savings Totals</h3>
                <div class="chart-container"><canvas id="chart2"></canvas></div>
              </div>
            </div>
            
            <!-- Funding Department Chart -->
            ${(report.chartData?.fundingDeptTotals?.labels?.length > 0) ? `
            <div style="margin-top: 24px;">
              <h3 style="margin-bottom: 12px; color: var(--primary-dark);">Savings by Funding Department</h3>
              <div class="chart-container"><canvas id="chart3"></canvas></div>
            </div>
            ` : ''}
            
            <div class="commentary-section">
              <div class="commentary-label">Financial Overview Commentary</div>
              <textarea class="commentary-textarea" id="financialOverviewCommentary" 
                placeholder="Add financial analysis commentary...">${report.financialOverview?.commentary || ''}</textarea>
            </div>
          </div>
        </div>
        
        <!-- OEM Summary Table -->
        <div class="card">
          <div class="card-header"><h2>Savings by OEM</h2></div>
          <div class="card-body">
            <table class="data-table">
              <thead>
                <tr>${(tables.oemSummary?.headers || ['OEM', 'Savings', '% of Total', 'Transactions', 'CPL', 'Paid']).map(h => `<th>${h}</th>`).join('')}</tr>
              </thead>
              <tbody>
                ${(tables.oemSummary?.rows || []).map(row => `
                  <tr>
                    <td>${row[0]}</td>
                    <td class="numeric">${row[1]}</td>
                    <td class="numeric">${row[2]}</td>
                    <td class="numeric">${row[3]}</td>
                    <td class="numeric">${row[4]}</td>
                    <td class="numeric">${row[5]}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Monthly Summary Table -->
        <div class="card">
          <div class="card-header"><h2>Savings by Month</h2></div>
          <div class="card-body">
            <table class="data-table">
              <thead>
                <tr>${(tables.monthSummary?.headers || ['Period', 'Savings', '% of Total', 'Transactions']).map(h => `<th>${h}</th>`).join('')}</tr>
              </thead>
              <tbody>
                ${(tables.monthSummary?.rows || []).map(row => `
                  <tr>
                    <td>${row[0]}</td>
                    <td class="numeric">${row[1]}</td>
                    <td class="numeric">${row[2]}</td>
                    <td class="numeric">${row[3]}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Funding Department Summary Table -->
        ${(tables.fundingDeptSummary?.rows?.length > 0) ? `
        <div class="card">
          <div class="card-header"><h2>Savings by Funding Department</h2></div>
          <div class="card-body">
            <table class="data-table">
              <thead>
                <tr>${(tables.fundingDeptSummary?.headers || ['Funding Dept', 'Savings', '% of Total', 'Transactions', 'Discount Rate']).map(h => `<th>${h}</th>`).join('')}</tr>
              </thead>
              <tbody>
                ${(tables.fundingDeptSummary?.rows || []).map(row => `
                  <tr>
                    <td>${row[0]}</td>
                    <td class="numeric">${row[1]}</td>
                    <td class="numeric">${row[2]}</td>
                    <td class="numeric">${row[3]}</td>
                    <td class="numeric">${row[4]}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
            
            <div class="commentary-section">
              <div class="commentary-label">Funding Department Commentary</div>
              <textarea class="commentary-textarea" id="fundingDeptCommentary" 
                placeholder="Add commentary on funding department analysis...">${report.fundingDeptAnalysis?.commentary || ''}</textarea>
            </div>
          </div>
        </div>
        ` : ''}
        
        <!-- Methodology -->
        <div class="card">
          <div class="card-header"><h2>Methodology</h2></div>
          <div class="card-body">
            <p><strong>Data Source:</strong> ${report.methodology?.data?.dataSource || 'N/A'}</p>
            <p><strong>Validation Criteria:</strong> ${report.methodology?.data?.validationCriteria || 'N/A'}</p>
            <p><strong>Excluded Transactions:</strong> ${report.methodology?.data?.excludedTransactions || 0}</p>
            <p><strong>Calculation Method:</strong> ${report.methodology?.data?.calculationMethod || 'N/A'}</p>
            
            <div class="commentary-section">
              <div class="commentary-label">Methodology Commentary</div>
              <textarea class="commentary-textarea" id="methodologyCommentary" 
                placeholder="Add methodology notes...">${report.methodology?.commentary || ''}</textarea>
            </div>
          </div>
        </div>
        
        <!-- Addendum -->
        <div class="card">
          <div class="card-header"><h2>Addendum</h2></div>
          <div class="card-body">
            <div class="commentary-section" style="margin-top: 0; padding-top: 0; border-top: none;">
              <div class="commentary-label">Additional Notes</div>
              <textarea class="commentary-textarea" id="addendumCommentary" 
                placeholder="Add any additional notes...">${report.addendum?.commentary || ''}</textarea>
            </div>
          </div>
        </div>
      `;
      
      setTimeout(() => renderCharts(report.chartData), 100);
    }
    
    // Render charts
    function renderCharts(chartData) {
      if (!chartData) return;
      
      if (chart1Instance) { chart1Instance.destroy(); chart1Instance = null; }
      if (chart2Instance) { chart2Instance.destroy(); chart2Instance = null; }
      if (chart3Instance) { chart3Instance.destroy(); chart3Instance = null; }
      
      const colors = ['#144673', '#3a6ea5', '#5a9bd4', '#f47920', '#ff8c42', '#22c55e', '#8b5cf6', '#ef4444', '#06b6d4', '#f59e0b'];
      
      // Chart 1: Stacked OEM by Month
      if (chartData.stackedOEM) {
        const ctx1 = document.getElementById('chart1');
        if (ctx1) {
          chart1Instance = new Chart(ctx1, {
            type: 'bar',
            data: {
              labels: chartData.stackedOEM.labels || [],
              datasets: (chartData.stackedOEM.datasets || []).map((ds, idx) => ({
                label: ds.label,
                data: ds.data,
                backgroundColor: colors[idx % colors.length],
                borderColor: colors[idx % colors.length],
                borderWidth: 1
              }))
            },
            options: {
              indexAxis: 'y',
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: { stacked: true, ticks: { callback: v => '$' + (v / 1000000).toFixed(1) + 'M' } },
                y: { stacked: true }
              },
              plugins: {
                tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': $' + (ctx.raw / 1000000).toFixed(2) + 'M' } },
                legend: { position: 'bottom' }
              }
            }
          });
        }
      }
      
      // Chart 2: Monthly Totals
      if (chartData.monthlyTotals) {
        const ctx2 = document.getElementById('chart2');
        if (ctx2) {
          chart2Instance = new Chart(ctx2, {
            type: 'bar',
            data: {
              labels: chartData.monthlyTotals.labels || [],
              datasets: [{
                label: 'Savings',
                data: chartData.monthlyTotals.data || [],
                backgroundColor: '#144673',
                borderColor: '#0a2240',
                borderWidth: 1
              }]
            },
            options: {
              indexAxis: 'y',
              responsive: true,
              maintainAspectRatio: false,
              scales: { x: { ticks: { callback: v => '$' + (v / 1000000).toFixed(1) + 'M' } } },
              plugins: {
                tooltip: { 
                  callbacks: { 
                    label: ctx => {
                      const pct = chartData.monthlyTotals.percentages?.[ctx.dataIndex] || '';
                      return 'Savings: $' + (ctx.raw / 1000000).toFixed(2) + 'M' + (pct ? ' (' + pct + '%)' : '');
                    }
                  }
                },
                legend: { display: false }
              }
            }
          });
        }
      }
      
      // Chart 3: Funding Department Totals
      if (chartData.fundingDeptTotals && chartData.fundingDeptTotals.labels?.length > 0) {
        const ctx3 = document.getElementById('chart3');
        if (ctx3) {
          chart3Instance = new Chart(ctx3, {
            type: 'bar',
            data: {
              labels: chartData.fundingDeptTotals.labels || [],
              datasets: [{
                label: 'Savings',
                data: chartData.fundingDeptTotals.data || [],
                backgroundColor: '#f47920',
                borderColor: '#c45f18',
                borderWidth: 1
              }]
            },
            options: {
              indexAxis: 'y',
              responsive: true,
              maintainAspectRatio: false,
              scales: { x: { ticks: { callback: v => '$' + (v / 1000000).toFixed(1) + 'M' } } },
              plugins: {
                tooltip: { 
                  callbacks: { 
                    label: ctx => {
                      const pct = chartData.fundingDeptTotals.percentages?.[ctx.dataIndex] || '';
                      return 'Savings: $' + (ctx.raw / 1000000).toFixed(2) + 'M' + (pct ? ' (' + pct + '%)' : '');
                    }
                  }
                },
                legend: { display: false }
              }
            }
          });
        }
      }
    }
    
    // Format currency
    function formatCurrency(value) {
      if (value === null || value === undefined || isNaN(value)) return '$0';
      const absValue = Math.abs(value);
      const sign = value < 0 ? '-' : '';
      if (absValue >= 1000000000) return sign + '$' + (absValue / 1000000000).toFixed(1) + 'B';
      if (absValue >= 1000000) return sign + '$' + (absValue / 1000000).toFixed(1) + 'M';
      if (absValue >= 1000) return sign + '$' + (absValue / 1000).toFixed(1) + 'K';
      return sign + '$' + absValue.toFixed(0);
    }
    
    // Save commentary
    function saveCommentary() {
      if (!currentReport || !currentRowNum) {
        alert('Please select a report first');
        return;
      }
      
      // Update commentary from textareas
      currentReport.executiveSummary = currentReport.executiveSummary || {};
      currentReport.executiveSummary.commentary = document.getElementById('executiveSummaryCommentary')?.value || '';
      
      currentReport.financialOverview = currentReport.financialOverview || {};
      currentReport.financialOverview.commentary = document.getElementById('financialOverviewCommentary')?.value || 
                                                    document.getElementById('oemGaugesCommentary')?.value || '';
      
      currentReport.methodology = currentReport.methodology || {};
      currentReport.methodology.commentary = document.getElementById('methodologyCommentary')?.value || '';
      
      currentReport.addendum = currentReport.addendum || {};
      currentReport.addendum.commentary = document.getElementById('addendumCommentary')?.value || '';
      
      // Save overall gauge commentary
      if (currentReport.gaugeData && currentReport.gaugeData.overall) {
        currentReport.gaugeData.overall.commentary = document.getElementById('overallGaugeCommentary')?.value || '';
      }
      
      // Save funding dept commentary
      currentReport.fundingDeptAnalysis = currentReport.fundingDeptAnalysis || {};
      currentReport.fundingDeptAnalysis.commentary = document.getElementById('fundingDeptCommentary')?.value || '';
      
      google.script.run
        .withSuccessHandler(result => {
          if (result.success) {
            alert('Commentary saved successfully!');
          } else {
            alert('Failed to save: ' + (result.error || 'Unknown error'));
          }
        })
        .withFailureHandler(err => {
          alert('Failed to save: ' + err.message);
        })
        .updateReportJson(currentRowNum, currentReport);
    }
    
    // Approval functions
    function approveLevel(level) {
      if (!currentRowNum) return;
      
      if (!confirm(`Are you sure you want to approve Level ${level}?`)) return;
      
      showLoading(`Processing Level ${level} approval...`);
      
      google.script.run
        .withSuccessHandler(result => {
          if (result.success) {
            alert(result.message);
            refreshReports();
          } else {
            showError(result.error);
          }
        })
        .withFailureHandler(err => {
          showError('Approval failed: ' + err.message);
        })
        .approveReport(currentRowNum, level);
    }
    
    function showRejectionModal() {
      const modal = document.getElementById('modalContainer');
      modal.innerHTML = `
        <div class="modal-overlay" onclick="closeModal(event)">
          <div class="modal-content rejection-modal" onclick="event.stopPropagation()">
            <div class="modal-icon">‚ùå</div>
            <div class="modal-title">Reject Report</div>
            <div class="modal-message">Please provide a reason for rejection:</div>
            <textarea id="rejectionReason" placeholder="Enter rejection reason..."></textarea>
            <div class="modal-actions">
              <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
              <button class="btn btn-danger" onclick="submitRejection()">Reject Report</button>
            </div>
          </div>
        </div>
      `;
    }
    
    function submitRejection() {
      const reason = document.getElementById('rejectionReason')?.value || '';
      
      if (!reason.trim()) {
        alert('Please provide a reason for rejection');
        return;
      }
      
      closeModal();
      showLoading('Processing rejection...');
      
      google.script.run
        .withSuccessHandler(result => {
          if (result.success) {
            alert(result.message);
            refreshReports();
          } else {
            showError(result.error);
          }
        })
        .withFailureHandler(err => {
          showError('Rejection failed: ' + err.message);
        })
        .rejectReport(currentRowNum, reason);
    }
    
    function closeModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('modalContainer').innerHTML = '';
    }
    
    // UI helpers
    function showLoading(message = 'Loading...') {
      document.getElementById('mainContent').innerHTML = `
        <div class="loading-container">
          <div class="loading-spinner"></div>
          <p>${message}</p>
        </div>
      `;
    }
    
    function showError(message) {
      document.getElementById('mainContent').innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">‚ö†Ô∏è</div>
          <p style="color: var(--danger);">${message}</p>
          <button class="btn btn-secondary" onclick="refreshReports()" style="margin-top: 16px;">üîÑ Retry</button>
        </div>
      `;
    }
    
    function showEmptyState(message) {
      document.getElementById('mainContent').innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">üìã</div>
          <p>${message}</p>
        </div>
      `;
    }
  </script>
</body>
</html>