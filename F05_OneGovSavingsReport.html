<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OneGov Savings Report Viewer</title>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- html2canvas for chart export -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  
  <style>
    :root {
      --primary-dark: #0a2240;
      --primary: #144673;
      --primary-light: #3a6ea5;
      --accent: #f47920;
      --accent-light: #ff8c42;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-600: #4b5563;
      --gray-800: #1f2937;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--gray-100);
      color: var(--gray-800);
      line-height: 1.5;
    }
    
    /* Header */
    .header {
      background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
      color: white;
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .header h1 { font-size: 24px; font-weight: 600; }
    .header-actions { display: flex; gap: 12px; flex-wrap: wrap; }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { background: var(--accent-light); }
    .btn-secondary { background: white; color: var(--primary); border: 1px solid var(--gray-300); }
    .btn-secondary:hover { background: var(--gray-100); }
    .btn-success { background: var(--success); color: white; }
    .btn-success:hover { background: #16a34a; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-danger:hover { background: #dc2626; }
    .btn-warning { background: var(--warning); color: white; }
    .btn-warning:hover { background: #d97706; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    /* Report Selector */
    .report-selector {
      background: white;
      padding: 20px 30px;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 20px;
    }
    
    .selector-group { display: flex; align-items: center; gap: 10px; }
    .selector-group label { font-weight: 500; color: var(--gray-600); white-space: nowrap; }
    .selector-group select {
      padding: 10px 15px;
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      font-size: 14px;
      min-width: 300px;
      background: white;
    }
    .selector-group select:disabled { background: var(--gray-100); cursor: not-allowed; }
    
    .report-count {
      font-size: 13px;
      color: var(--gray-600);
      padding: 6px 12px;
      background: var(--gray-100);
      border-radius: 20px;
    }
    
    /* Status Badge */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
    }
    .status-badge.under-review { background: #fef3c7; color: #92400e; }
    .status-badge.approved { background: #dcfce7; color: #166534; }
    
    /* Review Panel */
    .review-panel {
      background: #fef3c7;
      border: 1px solid #fbbf24;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 24px;
    }
    .review-panel.approved { background: #dcfce7; border-color: #22c55e; }
    .review-panel h3 { margin-bottom: 12px; color: var(--primary-dark); }
    
    .review-actions { display: flex; gap: 12px; margin-top: 16px; flex-wrap: wrap; }
    
    .review-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    
    .review-item { display: flex; align-items: center; gap: 8px; }
    .review-item .icon { font-size: 18px; }
    .review-item.pending .icon { color: var(--warning); }
    .review-item.complete .icon { color: var(--success); }
    
    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 30px;
      max-width: 500px;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    }
    
    .modal-icon { font-size: 48px; margin-bottom: 16px; }
    .modal-title { font-size: 20px; font-weight: 600; margin-bottom: 12px; color: var(--primary-dark); }
    .modal-message { color: var(--gray-600); margin-bottom: 20px; }
    
    .rejection-modal textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      font-family: inherit;
      font-size: 14px;
      margin-bottom: 16px;
    }
    
    .modal-actions { display: flex; gap: 12px; justify-content: flex-end; }
    
    /* Main Content */
    .main-content { max-width: 1200px; margin: 30px auto; padding: 0 30px; }
    
    /* Cards */
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 24px;
      overflow: hidden;
    }
    
    .card-header {
      background: var(--gray-50);
      padding: 16px 24px;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .card-header h2 { font-size: 18px; font-weight: 600; color: var(--primary-dark); }
    .card-body { padding: 24px; }
    
    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
    }
    
    .stat-item {
      background: var(--gray-50);
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    
    .stat-value { font-size: 28px; font-weight: 700; color: var(--primary); margin-bottom: 4px; }
    .stat-value.highlight { color: var(--success); }
    .stat-label {
      font-size: 13px;
      color: var(--gray-600);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* Charts */
    .chart-container { position: relative; width: 100%; min-height: 400px; }
    .chart-row { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
    @media (max-width: 900px) { .chart-row { grid-template-columns: 1fr; } }
    
    /* Tables */
    .data-table { width: 100%; border-collapse: collapse; font-size: 14px; }
    .data-table th, .data-table td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--gray-200);
    }
    .data-table th {
      background: var(--gray-50);
      font-weight: 600;
      color: var(--gray-600);
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 0.5px;
    }
    .data-table tr:hover { background: var(--gray-50); }
    .data-table .numeric { text-align: right; }
    
    /* Commentary */
    .commentary-section { margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--gray-200); }
    .commentary-label { font-weight: 500; margin-bottom: 8px; color: var(--gray-600); }
    .commentary-textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
    }
    
    /* Toast */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 16px 24px;
      background: var(--gray-800);
      color: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }
    .toast.success { background: var(--success); }
    .toast.error { background: var(--danger); }
    .toast.info { background: var(--primary); }
    .toast.warning { background: var(--warning); }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    /* Loading */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px;
      color: var(--gray-600);
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--gray-200);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="header">
    <h1>üìä OneGov Savings Report Viewer</h1>
    <div class="header-actions">
      <button class="btn btn-secondary" onclick="goBack()">‚Üê Back</button>
      <button class="btn btn-warning" onclick="viewDocument()" id="viewDocBtn" style="display:none;">üìÑ View Document</button>
      <button class="btn btn-secondary" onclick="openDocument()" id="editDocBtn" style="display:none;">üìù Edit Document</button>
      <button class="btn btn-secondary" onclick="saveCommentary()" id="saveBtn" disabled>üíæ Save</button>
      <button class="btn btn-secondary" onclick="emailReport()" id="emailBtn" disabled>üìß Email</button>
      <button class="btn btn-primary" onclick="downloadPDF()" id="pdfBtn" disabled>üìÑ PDF</button>
    </div>
  </div>
  
  <div class="report-selector">
    <div class="selector-group">
      <label for="reportType">Report Type:</label>
      <select id="reportType" onchange="filterReports()">
        <option value="">All Report Types</option>
        <option value="OneGov Monthly Savings">OneGov Monthly Savings</option>
        <option value="Discount Offers">Discount Offers</option>
      </select>
    </div>
    
    <div class="selector-group">
      <label for="reportSelect">Select Report:</label>
      <select id="reportSelect" onchange="loadSelectedReport()">
        <option value="">-- Select a report --</option>
      </select>
    </div>
    
    <div class="report-count" id="reportCount">Loading reports...</div>
  </div>
  
  <div class="main-content">
    <!-- Access Denied Modal -->
    <div class="modal-overlay" id="accessDeniedModal" style="display: none;">
      <div class="modal-content">
        <div class="modal-icon">üîí</div>
        <div class="modal-title">Report Under Review</div>
        <div class="modal-message">
          This report is currently under review. Once it has been approved by both reviewers, it will be available for viewing.
        </div>
        <button class="btn btn-primary" onclick="closeAccessModal()">OK</button>
      </div>
    </div>
    
    <!-- Rejection Modal -->
    <div class="modal-overlay rejection-modal" id="rejectionModal" style="display: none;">
      <div class="modal-content">
        <div class="modal-icon">‚ùå</div>
        <div class="modal-title">Reject Report</div>
        <div class="modal-message">Please provide a reason for rejecting this report (optional):</div>
        <textarea id="rejectionReason" placeholder="Enter rejection reason..."></textarea>
        <div class="modal-actions">
          <button class="btn btn-secondary" onclick="closeRejectionModal()">Cancel</button>
          <button class="btn btn-danger" onclick="confirmRejection()">Reject Report</button>
        </div>
      </div>
    </div>
    
    <div id="reportContainer">
      <div class="loading">
        <div class="spinner"></div>
        <div>Loading reports...</div>
      </div>
    </div>
  </div>
  
  <script>
    // Global state
    let allReports = [];
    let currentReport = null;
    let currentRowNum = null;
    let currentAccess = null;
    let currentDriveUrl = null;
    let chart1Instance = null;
    let chart2Instance = null;
    
    // Initialize
    document.addEventListener('DOMContentLoaded', loadReports);
    
    // Load reports
    function loadReports() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.error) {
            showToast('Error: ' + result.error, 'error');
            return;
          }
          allReports = result.reports || [];
          document.getElementById('reportCount').textContent = allReports.length + ' reports available';
          filterReports();
        })
        .withFailureHandler(function(error) {
          showToast('Failed to load reports: ' + error.message, 'error');
        })
        .getReportsWithReviewStatus();
    }
    
    // Filter reports
    function filterReports() {
      const typeFilter = document.getElementById('reportType').value;
      const select = document.getElementById('reportSelect');
      select.innerHTML = '<option value="">-- Select a report --</option>';
      
      const filtered = allReports.filter(r => {
        if (!typeFilter) return r.hasJson;
        return r.reportType === typeFilter && r.hasJson;
      });
      
      filtered.forEach(report => {
        const opt = document.createElement('option');
        opt.value = report.rowNum;
        const statusIcon = report.reviewStatus?.isFullyApproved ? '‚úÖ' : 'üî∂';
        const period = report.json?.reportingPeriod || 'Unknown period';
        const savings = report.json?.executiveSummary?.data?.totalSavingsFormatted || '';
        opt.textContent = `${statusIcon} ${report.reportType} - ${period} ${savings ? '(' + savings + ')' : ''}`;
        select.appendChild(opt);
      });
      
      document.getElementById('reportCount').textContent = filtered.length + ' reports shown';
    }
    
    // Load selected report
    function loadSelectedReport() {
      const rowNum = document.getElementById('reportSelect').value;
      if (!rowNum) {
        document.getElementById('reportContainer').innerHTML = `<div class="loading"><div>Select a report to view</div></div>`;
        disableButtons();
        return;
      }
      
      const report = allReports.find(r => r.rowNum == rowNum);
      if (!report || !report.json) {
        showToast('Report data not found', 'error');
        return;
      }
      
      currentAccess = report.access || { canAccess: true, canEdit: false, canReview: false };
      currentDriveUrl = report.driveUrl || '';
      currentRowNum = rowNum;
      currentReport = report.json;
      
      // Always render the report view from JSON
      renderReport(report);
      enableButtons();
      
      // Show View Document button always
      document.getElementById('viewDocBtn').style.display = 'inline-flex';
      
      // Show Edit button only for reviewers with existing doc
      if (currentAccess.canEdit && currentDriveUrl) {
        document.getElementById('editDocBtn').style.display = 'inline-flex';
      } else {
        document.getElementById('editDocBtn').style.display = 'none';
      }
    }
    
    // Open document for editing
    function openDocument() {
      if (currentDriveUrl) {
        window.open(currentDriveUrl, '_blank');
      } else {
        // Generate document first - show centered modal like Entity Profile
        const loadingModal = document.createElement('div');
        loadingModal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10002;';
        loadingModal.innerHTML = `
          <div style="background: white; padding: 30px; border-radius: 12px; text-align: center;">
            <div style="font-size: 2rem; margin-bottom: 10px;">üìÑ</div>
            <div style="color: #333; font-weight: 600;">Generating Document...</div>
            <div style="color: #666; font-size: 0.9rem; margin-top: 5px;">Please wait</div>
          </div>
        `;
        document.body.appendChild(loadingModal);
        
        google.script.run
          .withSuccessHandler(function(result) {
            loadingModal.remove();
            if (result.success) {
              currentDriveUrl = result.docUrl;
              window.open(result.docUrl, '_blank');
              showToast('Document opened', 'success');
              // Show view/edit buttons
              document.getElementById('viewDocBtn').style.display = 'inline-flex';
              document.getElementById('editDocBtn').style.display = currentAccess?.canEdit ? 'inline-flex' : 'none';
            } else {
              showToast('Failed: ' + (result.error || 'Unknown error'), 'error');
            }
          })
          .withFailureHandler(function(error) {
            loadingModal.remove();
            showToast('Failed: ' + error.message, 'error');
          })
          .generateTDRReportDocument(parseInt(currentRowNum));
      }
    }
    
    // View document (generate if needed, then open)
    function viewDocument() {
      if (!currentRowNum) {
        showToast('No report selected', 'error');
        return;
      }
      
      if (currentDriveUrl) {
        window.open(currentDriveUrl, '_blank');
      } else {
        // Generate document first - show centered modal like Entity Profile
        const loadingModal = document.createElement('div');
        loadingModal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10002;';
        loadingModal.innerHTML = `
          <div style="background: white; padding: 30px; border-radius: 12px; text-align: center;">
            <div style="font-size: 2rem; margin-bottom: 10px;">üìÑ</div>
            <div style="color: #333; font-weight: 600;">Generating Document...</div>
            <div style="color: #666; font-size: 0.9rem; margin-top: 5px;">Please wait</div>
          </div>
        `;
        document.body.appendChild(loadingModal);
        
        google.script.run
          .withSuccessHandler(function(result) {
            loadingModal.remove();
            if (result.success) {
              currentDriveUrl = result.docUrl;
              // Update in allReports array
              const idx = allReports.findIndex(r => r.rowNum == currentRowNum);
              if (idx !== -1) {
                allReports[idx].driveUrl = result.docUrl;
              }
              showToast('Document ready!', 'success');
              window.open(result.docUrl, '_blank');
              // Show edit button if reviewer
              if (currentAccess?.canEdit) {
                document.getElementById('editDocBtn').style.display = 'inline-flex';
              }
            } else {
              showToast('Failed: ' + (result.error || 'Unknown error'), 'error');
            }
          })
          .withFailureHandler(function(error) {
            loadingModal.remove();
            showToast('Failed: ' + error.message, 'error');
          })
          .generateTDRReportDocument(parseInt(currentRowNum));
      }
    }
    
    // Show/close modals
    function showAccessDeniedModal() { document.getElementById('accessDeniedModal').style.display = 'flex'; }
    function closeAccessModal() { 
      document.getElementById('accessDeniedModal').style.display = 'none';
      document.getElementById('reportSelect').value = '';
    }
    function showRejectionModal() { 
      document.getElementById('rejectionModal').style.display = 'flex';
      document.getElementById('rejectionReason').value = '';
    }
    function closeRejectionModal() { document.getElementById('rejectionModal').style.display = 'none'; }
    
    function confirmRejection() {
      const reason = document.getElementById('rejectionReason').value;
      closeRejectionModal();
      rejectReport(reason);
    }
    
    // Render report
    function renderReport(reportData) {
      const report = reportData.json;
      const reviewStatus = reportData.reviewStatus || { isFullyApproved: false, hasLevel1Review: false, hasLevel2Review: false };
      const access = reportData.access || { canAccess: true, canEdit: false, canReview: false };
      
      const container = document.getElementById('reportContainer');
      
      if (!report) {
        container.innerHTML = '<div class="loading"><div>No report data available</div></div>';
        return;
      }
      
      // Build review panel
      let reviewPanelHTML = '';
      if (!reviewStatus.isFullyApproved) {
        const canApproveLevel1 = access.needsLevel1Review;
        const canApproveLevel2 = access.needsLevel2Review;
        
        reviewPanelHTML = `
          <div class="review-panel">
            <h3>üî∂ Report Under Review</h3>
            <div class="review-info">
              <div class="review-item ${reviewStatus.hasLevel1Review ? 'complete' : 'pending'}">
                <span class="icon">${reviewStatus.hasLevel1Review ? '‚úÖ' : '‚è≥'}</span>
                <span>Level 1: ${reviewStatus.level1Reviewer || 'Not assigned'}</span>
                ${reviewStatus.level1Timestamp ? '<small style="color:#666;margin-left:8px;">' + new Date(reviewStatus.level1Timestamp).toLocaleString() + '</small>' : ''}
              </div>
              <div class="review-item ${reviewStatus.hasLevel2Review ? 'complete' : 'pending'}">
                <span class="icon">${reviewStatus.hasLevel2Review ? '‚úÖ' : '‚è≥'}</span>
                <span>Level 2: ${reviewStatus.level2Reviewer || 'Not assigned'}</span>
                ${reviewStatus.level2Timestamp ? '<small style="color:#666;margin-left:8px;">' + new Date(reviewStatus.level2Timestamp).toLocaleString() + '</small>' : ''}
              </div>
            </div>
            ${access.canReview ? `
              <div class="review-actions">
                ${canApproveLevel1 ? '<button class="btn btn-success" onclick="approveLevel(1)">‚úì Approve (Level 1)</button>' : ''}
                ${canApproveLevel2 ? '<button class="btn btn-success" onclick="approveLevel(2)">‚úì Approve (Level 2)</button>' : ''}
                ${!canApproveLevel1 && !canApproveLevel2 && reviewStatus.hasLevel1Review && !access.isLevel2Reviewer ? '<span style="color:#666;">Waiting for Level 2 reviewer</span>' : ''}
                <button class="btn btn-danger" onclick="showRejectionModal()">‚úó Reject</button>
                ${currentDriveUrl ? '<button class="btn btn-warning" onclick="openDocument()">üìù Edit Document</button>' : ''}
              </div>
            ` : ''}
          </div>
        `;
      } else {
        reviewPanelHTML = `
          <div class="review-panel approved">
            <h3>‚úÖ Report Approved</h3>
            <div class="review-info">
              <div class="review-item complete">
                <span class="icon">‚úÖ</span>
                <span>Level 1: ${reviewStatus.level1Reviewer}</span>
                <small style="color:#666;margin-left:8px;">${new Date(reviewStatus.level1Timestamp).toLocaleString()}</small>
              </div>
              <div class="review-item complete">
                <span class="icon">‚úÖ</span>
                <span>Level 2: ${reviewStatus.level2Reviewer}</span>
                <small style="color:#666;margin-left:8px;">${new Date(reviewStatus.level2Timestamp).toLocaleString()}</small>
              </div>
            </div>
          </div>
        `;
      }
      
      container.innerHTML = `
        ${reviewPanelHTML}
        
        <!-- Executive Summary -->
        <div class="card">
          <div class="card-header">
            <h2>Executive Summary</h2>
            <span class="status-badge ${reviewStatus.isFullyApproved ? 'approved' : 'under-review'}">
              ${reviewStatus.isFullyApproved ? '‚úÖ Approved' : 'üî∂ Under Review'}
            </span>
          </div>
          <div class="card-body">
            <div class="stats-grid">
              <div class="stat-item">
                <div class="stat-value highlight">${report.executiveSummary?.data?.totalSavingsFormatted || '$0'}</div>
                <div class="stat-label">Total Savings</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${report.executiveSummary?.data?.totalTransactions || 0}</div>
                <div class="stat-label">Transactions</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${report.executiveSummary?.data?.overallDiscountRate || '0%'}</div>
                <div class="stat-label">Discount Rate</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${report.executiveSummary?.data?.oemCount || 0}</div>
                <div class="stat-label">OEMs</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${report.executiveSummary?.data?.vendorCount || 0}</div>
                <div class="stat-label">Vendors</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${report.executiveSummary?.data?.topOEM || 'N/A'}</div>
                <div class="stat-label">Top OEM (${report.executiveSummary?.data?.topOEMPercent || 0}%)</div>
              </div>
            </div>
            
            <div class="commentary-section">
              <div class="commentary-label">Executive Summary Commentary</div>
              <textarea class="commentary-textarea" id="executiveSummaryCommentary" 
                placeholder="Add executive summary commentary...">${report.executiveSummary?.commentary || ''}</textarea>
            </div>
          </div>
        </div>
        
        <!-- Charts -->
        <div class="card">
          <div class="card-header"><h2>Financial Overview - Charts</h2></div>
          <div class="card-body">
            <div class="chart-row">
              <div>
                <h3 style="margin-bottom: 12px; color: var(--primary-dark);">Savings by OEM (Stacked by Month)</h3>
                <div class="chart-container"><canvas id="chart1"></canvas></div>
              </div>
              <div>
                <h3 style="margin-bottom: 12px; color: var(--primary-dark);">Monthly Savings Totals</h3>
                <div class="chart-container"><canvas id="chart2"></canvas></div>
              </div>
            </div>
            
            <div class="commentary-section">
              <div class="commentary-label">Financial Overview Commentary</div>
              <textarea class="commentary-textarea" id="financialOverviewCommentary" 
                placeholder="Add financial analysis commentary...">${report.financialOverview?.commentary || ''}</textarea>
            </div>
          </div>
        </div>
        
        <!-- OEM Summary Table -->
        <div class="card">
          <div class="card-header"><h2>Savings by OEM</h2></div>
          <div class="card-body">
            <table class="data-table">
              <thead>
                <tr>${(report.tables?.oemSummary?.headers || []).map(h => `<th>${h}</th>`).join('')}</tr>
              </thead>
              <tbody>
                ${(report.tables?.oemSummary?.rows || []).map(row => `
                  <tr>
                    <td>${row[0]}</td>
                    <td class="numeric">${row[1]}</td>
                    <td class="numeric">${row[2]}</td>
                    <td class="numeric">${row[3]}</td>
                    <td class="numeric">${row[4]}</td>
                    <td class="numeric">${row[5]}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Monthly Summary Table -->
        <div class="card">
          <div class="card-header"><h2>Savings by Month</h2></div>
          <div class="card-body">
            <table class="data-table">
              <thead>
                <tr>${(report.tables?.monthSummary?.headers || []).map(h => `<th>${h}</th>`).join('')}</tr>
              </thead>
              <tbody>
                ${(report.tables?.monthSummary?.rows || []).map(row => `
                  <tr>
                    <td>${row[0]}</td>
                    <td class="numeric">${row[1]}</td>
                    <td class="numeric">${row[2]}</td>
                    <td class="numeric">${row[3]}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Methodology -->
        <div class="card">
          <div class="card-header"><h2>Methodology</h2></div>
          <div class="card-body">
            <p><strong>Data Source:</strong> ${report.methodology?.data?.dataSource || 'N/A'}</p>
            <p><strong>Validation Criteria:</strong> ${report.methodology?.data?.validationCriteria || 'N/A'}</p>
            <p><strong>Excluded Transactions:</strong> ${report.methodology?.data?.excludedTransactions || 0}</p>
            <p><strong>Calculation Method:</strong> ${report.methodology?.data?.calculationMethod || 'N/A'}</p>
            
            <div class="commentary-section">
              <div class="commentary-label">Methodology Commentary</div>
              <textarea class="commentary-textarea" id="methodologyCommentary" 
                placeholder="Add methodology notes...">${report.methodology?.commentary || ''}</textarea>
            </div>
          </div>
        </div>
        
        <!-- Addendum -->
        <div class="card">
          <div class="card-header"><h2>Addendum</h2></div>
          <div class="card-body">
            <div class="commentary-section" style="margin-top: 0; padding-top: 0; border-top: none;">
              <div class="commentary-label">Additional Notes</div>
              <textarea class="commentary-textarea" id="addendumCommentary" 
                placeholder="Add any additional notes...">${report.addendum?.commentary || ''}</textarea>
            </div>
          </div>
        </div>
      `;
      
      setTimeout(() => renderCharts(report.chartData), 100);
    }
    
    // Render charts
    function renderCharts(chartData) {
      if (!chartData) return;
      
      if (chart1Instance) { chart1Instance.destroy(); chart1Instance = null; }
      if (chart2Instance) { chart2Instance.destroy(); chart2Instance = null; }
      
      const colors = ['#144673', '#3a6ea5', '#5a9bd4', '#f47920', '#ff8c42', '#22c55e', '#8b5cf6', '#ef4444', '#06b6d4', '#f59e0b'];
      
      // Chart 1: Stacked OEM by Month
      if (chartData.stackedOEM) {
        const ctx1 = document.getElementById('chart1');
        if (ctx1) {
          chart1Instance = new Chart(ctx1, {
            type: 'bar',
            data: {
              labels: chartData.stackedOEM.labels || [],
              datasets: (chartData.stackedOEM.datasets || []).map((ds, idx) => ({
                label: ds.label,
                data: ds.data,
                backgroundColor: colors[idx % colors.length],
                borderColor: colors[idx % colors.length],
                borderWidth: 1
              }))
            },
            options: {
              indexAxis: 'y',
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: { stacked: true, ticks: { callback: v => '$' + (v / 1000000).toFixed(1) + 'M' } },
                y: { stacked: true }
              },
              plugins: {
                tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': $' + (ctx.raw / 1000000).toFixed(2) + 'M' } },
                legend: { position: 'bottom' }
              }
            }
          });
        }
      }
      
      // Chart 2: Monthly Totals
      if (chartData.monthlyTotals) {
        const ctx2 = document.getElementById('chart2');
        if (ctx2) {
          chart2Instance = new Chart(ctx2, {
            type: 'bar',
            data: {
              labels: chartData.monthlyTotals.labels || [],
              datasets: [{
                label: 'Savings',
                data: chartData.monthlyTotals.data || [],
                backgroundColor: '#144673',
                borderColor: '#0a2240',
                borderWidth: 1
              }]
            },
            options: {
              indexAxis: 'y',
              responsive: true,
              maintainAspectRatio: false,
              scales: { x: { ticks: { callback: v => '$' + (v / 1000000).toFixed(1) + 'M' } } },
              plugins: {
                tooltip: { 
                  callbacks: { 
                    label: ctx => {
                      const pct = chartData.monthlyTotals.percentages?.[ctx.dataIndex] || '';
                      return 'Savings: $' + (ctx.raw / 1000000).toFixed(2) + 'M' + (pct ? ' (' + pct + '%)' : '');
                    }
                  }
                },
                legend: { display: false }
              }
            }
          });
        }
      }
    }
    
    // Approve at level
    function approveLevel(level) {
      if (!currentRowNum) { showToast('No report selected', 'error'); return; }
      
      showToast(`Processing Level ${level} approval...`, 'info');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showToast(result.message, 'success');
            loadReports();
            setTimeout(() => {
              document.getElementById('reportSelect').value = currentRowNum;
              loadSelectedReport();
            }, 1000);
          } else {
            showToast('Approval failed: ' + (result.error || 'Unknown error'), 'error');
          }
        })
        .withFailureHandler(error => showToast('Approval failed: ' + error.message, 'error'))
        .approveReport(parseInt(currentRowNum), level);
    }
    
    // Reject report
    function rejectReport(reason) {
      if (!currentRowNum) { showToast('No report selected', 'error'); return; }
      
      showToast('Processing rejection...', 'info');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showToast(result.message, 'success');
            loadReports();
            document.getElementById('reportSelect').value = '';
            document.getElementById('reportContainer').innerHTML = `<div class="loading"><div>Report rejected and returned for revision</div></div>`;
            disableButtons();
          } else {
            showToast('Rejection failed: ' + (result.error || 'Unknown error'), 'error');
          }
        })
        .withFailureHandler(error => showToast('Rejection failed: ' + error.message, 'error'))
        .rejectReport(parseInt(currentRowNum), reason);
    }
    
    // Save commentary
    function saveCommentary() {
      if (!currentReport || !currentRowNum) { showToast('No report loaded', 'error'); return; }
      
      currentReport.executiveSummary = currentReport.executiveSummary || {};
      currentReport.executiveSummary.commentary = document.getElementById('executiveSummaryCommentary')?.value || '';
      currentReport.financialOverview = currentReport.financialOverview || {};
      currentReport.financialOverview.commentary = document.getElementById('financialOverviewCommentary')?.value || '';
      currentReport.methodology = currentReport.methodology || {};
      currentReport.methodology.commentary = document.getElementById('methodologyCommentary')?.value || '';
      currentReport.addendum = currentReport.addendum || {};
      currentReport.addendum.commentary = document.getElementById('addendumCommentary')?.value || '';
      
      showToast('Saving commentary...', 'info');
      
      google.script.run
        .withSuccessHandler(result => {
          if (result.success) showToast('Commentary saved!', 'success');
          else showToast('Failed to save: ' + (result.error || 'Unknown error'), 'error');
        })
        .withFailureHandler(error => showToast('Failed to save: ' + error.message, 'error'))
        .updateReportJson(parseInt(currentRowNum), currentReport);
    }
    
    // Download PDF
    function downloadPDF() {
      if (!currentRowNum) { showToast('No report selected', 'error'); return; }
      
      showToast('Generating PDF...', 'info');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showToast('PDF ready!', 'success');
            window.open(result.pdfUrl, '_blank');
          } else {
            showToast('PDF failed: ' + (result.error || 'Unknown error'), 'error');
          }
        })
        .withFailureHandler(error => showToast('PDF failed: ' + error.message, 'error'))
        .exportTDRReportAsPDF(parseInt(currentRowNum));
    }
    
    // Email report
    function emailReport() {
      if (!currentRowNum) { showToast('No report selected', 'error'); return; }
      
      showToast('Sending email...', 'info');
      
      google.script.run
        .withSuccessHandler(result => {
          if (result.success) showToast(result.message, 'success');
          else showToast('Email failed: ' + (result.error || 'Unknown error'), 'error');
        })
        .withFailureHandler(error => showToast('Email failed: ' + error.message, 'error'))
        .emailTDRReport(parseInt(currentRowNum), null);
    }
    
    // Navigation
    function goBack() { google.script.run.showMainDashboard(); }
    
    // UI helpers
    function enableButtons() {
      document.getElementById('saveBtn').disabled = false;
      document.getElementById('pdfBtn').disabled = false;
      document.getElementById('emailBtn').disabled = false;
    }
    
    function disableButtons() {
      document.getElementById('saveBtn').disabled = true;
      document.getElementById('pdfBtn').disabled = true;
      document.getElementById('emailBtn').disabled = true;
      document.getElementById('editDocBtn').style.display = 'none';
      document.getElementById('viewDocBtn').style.display = 'none';
    }
    
    function showToast(message, type = 'info') {
      const existing = document.querySelector('.toast');
      if (existing) existing.remove();
      
      const toast = document.createElement('div');
      toast.className = 'toast ' + type;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.remove(), 4000);
    }
  </script>
</body>
</html>