<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>OneGov FIT Market - Main Dashboard v265</title>
    <!-- Version 265: Fixed OEM/Vendor percentage calculations and table padding -->
    
    <!-- React 18 CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- jQuery for welcome screen functionality -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <style>
        :root {
            --dark-blue: #0a2240;
            --blue: #144673;
            --light-blue: #3a6ea5;
            --orange: #f47920;
            --bg-light: #f4f6f7;
            --text-light: #ffffff;
            --text-dark: #333333;
            --shadow: 0 2px 8px rgba(0,0,0,0.12);
            --border-radius: 8px;
            --green: #22c55e;
            --red: #ef4444;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--text-dark);
            min-height: 100vh;
            font-size: 16px;
        }
        
        /* OneGov FIT Loader Styles */
        .onegov-loader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(245, 247, 250, 0.95);
            backdrop-filter: blur(5px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }
        
        .loader-card {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(20, 70, 115, 0.15);
            min-width: 400px;
            text-align: center;
        }
        
        .loader-logo {
            margin-bottom: 30px;
            animation: pulse 2s infinite;
        }
        
        .logo-text {
            font-size: 32px;
            font-weight: 700;
            color: #144673;
            background: linear-gradient(135deg, #144673 0%, #1e5a9a 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .logo-subtitle {
            font-size: 14px;
            color: #64748b;
            margin-top: 4px;
            letter-spacing: 2px;
        }
        
        .progress-container {
            margin: 30px 0;
        }
        
        .progress-bar {
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-bar::after {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: var(--progress, 0%);
            background: linear-gradient(90deg, #144673 0%, #f47920 100%);
            border-radius: 3px;
            transition: width 0.3s ease;
            animation: shimmer 2s infinite;
        }
        
        .progress-text {
            margin-top: 12px;
            color: #475569;
            font-size: 14px;
        }
        
        .loading-stats {
            color: #64748b;
            font-size: 13px;
            margin: 20px 0;
            min-height: 20px;
        }
        
        .powered-by {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
            color: #94a3b8;
            font-size: 12px;
        }
        
        .usai-badge {
            color: #144673;
            font-weight: 600;
            margin: 0 4px;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.02); opacity: 0.9; }
        }
        
        @keyframes shimmer {
            0% { filter: brightness(1); }
            50% { filter: brightness(1.2); }
            100% { filter: brightness(1); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Navigation Styles */
        .navbar {
            background: linear-gradient(135deg, var(--dark-blue) 0%, var(--blue) 100%);
            color: var(--text-light);
            padding: 1rem 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .nav-logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .nav-menu {
            display: flex;
            gap: 2rem;
            list-style: none;
        }
        
        .nav-menu a {
            color: var(--text-light);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
        }
        
        .nav-menu a:hover, .nav-menu a.active {
            background: rgba(255, 255, 255, 0.1);
            color: var(--orange);
        }
        
        /* Main Container */
        .main-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        
        .page-header {
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .page-title {
            font-size: 2.5rem;
            color: var(--dark-blue);
            margin-bottom: 0.5rem;
            font-weight: 700;
        }
        
        .page-subtitle {
            color: var(--blue);
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }
        
        /* Control Panel */
        .control-panel {
            background: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }
        
        .control-row {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .control-label {
            font-weight: 600;
            color: var(--dark-blue);
            font-size: 0.9rem;
        }
        
        .control-input {
            padding: 0.5rem;
            border: 2px solid #e5e7eb;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: var(--orange);
            color: white;
        }
        
        .btn-primary:hover {
            background: #e06d1c;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: var(--blue);
            color: white;
        }
        
        .btn-secondary:hover {
            background: var(--dark-blue);
        }
        
        /* Entity Grid */
        .entities-container {
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }
        
        .entities-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--bg-light);
        }
        
        .entities-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark-blue);
        }
        
        .entities-count {
            color: var(--blue);
            font-weight: 600;
        }
        
        .entities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        /* Entity Card */
        .entity-card {
            background: white;
            border: 2px solid #f0f0f0;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .entity-card:hover {
            border-color: var(--orange);
            box-shadow: var(--shadow);
            transform: translateY(-4px);
        }
        
        .entity-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--dark-blue);
            margin-bottom: 0.5rem;
        }
        
        .entity-type {
            background: var(--blue);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 1rem;
        }
        
        .entity-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--orange);
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: var(--blue);
            text-transform: uppercase;
        }
        
        /* Loading States */
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--blue);
        }
        
        .error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
            padding: 1rem;
            border-radius: var(--border-radius);
            margin: 1rem 0;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .control-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .entities-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .entities-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-menu {
                display: none;
            }
        }
        
        /* Entity Detail Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .modal-content {
            min-height: 100vh;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--dark-blue) 0%, var(--blue) 100%);
            color: white;
            padding: 16px 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .header-container {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .profile-card {
            background: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 24px;
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .profile-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .profile-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark-blue);
            margin-bottom: 8px;
        }
        
        .profile-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--blue);
        }
        
        .tier-badge {
            background: var(--green);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.8rem;
        }
        
        .action-links {
            display: flex;
            gap: 12px;
        }
        
        .action-link {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background-color 0.2s;
            border: none;
            cursor: pointer;
        }
        
        .website-link {
            background: var(--blue);
        }
        
        .website-link:hover {
            background: var(--dark-blue);
        }
        
        .linkedin-link {
            background: #0077B5;
        }
        
        .linkedin-link:hover {
            background: #005c8a;
        }
        
        .report-dropdown-btn {
            background: var(--orange);
        }
        
        .report-dropdown-btn:hover {
            background: #e67e22;
        }
        
        .close-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .content-container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 24px;
        }
        
        .section {
            margin-bottom: 32px;
        }
        
        .section-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--dark-blue);
            margin-bottom: 20px;
            padding-bottom: 8px;
            border-bottom: 3px solid var(--orange);
        }
        
        .overview-text {
            font-size: 1rem;
            line-height: 1.6;
            color: var(--text-dark);
            padding: 16px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid var(--orange);
        }

        /* OneGov FIT Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a2240 0%, #144673 50%, #3a6ea5 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            animation: fadeInOverlay 0.5s ease-out forwards;
        }

        .loading-content {
            text-align: center;
            color: white;
            position: relative;
        }

        .loading-logo {
            margin-bottom: 2rem;
        }

        .logo-circle {
            width: 120px;
            height: 120px;
            background: rgba(255, 255, 255, 0.1);
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            animation: logoFloat 3s ease-in-out infinite;
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: 1px;
            color: #f47920;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .logo-subtext {
            font-size: 0.9rem;
            font-weight: 600;
            letter-spacing: 2px;
            color: rgba(255, 255, 255, 0.9);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-top: 3px solid #f47920;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }

        .loading-message {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 1rem;
            min-height: 1.5rem;
            animation: messageGlow 2s ease-in-out infinite alternate;
        }

        .loading-progress {
            width: 300px;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            margin: 1rem auto;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #f47920, #ff8c42);
            border-radius: 2px;
            width: 0%;
            transition: width 0.3s ease;
        }

        .loading-subtitle {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 1rem;
            font-weight: 300;
            letter-spacing: 0.5px;
        }

        @keyframes fadeInOverlay {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes logoFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes messageGlow {
            0% { opacity: 0.8; }
            100% { opacity: 1; }
        }

        /* Welcome Screen Styles */
        .welcome-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeInOverlay 0.3s ease;
        }

        .welcome-container {
            background: white;
            border-radius: 20px;
            padding: 50px;
            max-width: 900px;
            width: 90%;
            box-shadow: 0 25px 60px rgba(20, 70, 115, 0.2);
        }

        .welcome-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .welcome-title {
            font-size: 36px;
            font-weight: 700;
            color: #144673;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #144673 0%, #1e5a9a 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .welcome-subtitle {
            font-size: 16px;
            color: #64748b;
            margin: 0;
        }

        .view-selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .view-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
            animation: slideUp 0.4s ease backwards;
        }

        .view-card:hover {
            border-color: #144673;
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(20, 70, 115, 0.15);
        }

        .view-card.selected {
            border-color: #f47920;
            background: linear-gradient(135deg, #fff9f5 0%, #fff5ed 100%);
        }

        .view-card.preferred {
            border-color: #22c55e;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        }

        .view-icon {
            font-size: 48px;
            margin-bottom: 15px;
            filter: grayscale(20%);
            transition: all 0.3s ease;
        }

        .view-card:hover .view-icon {
            filter: grayscale(0%);
            transform: scale(1.1);
        }

        .view-card h3 {
            font-size: 18px;
            color: #144673;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .view-card p {
            font-size: 13px;
            color: #64748b;
            margin: 0;
            line-height: 1.4;
        }

        .keyboard-hint {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #e2e8f0;
            color: #475569;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .view-card:hover .keyboard-hint {
            background: #144673;
            color: white;
        }

        .preferred-badge {
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            background: #22c55e;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .welcome-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }

        .powered-by {
            font-size: 12px;
            color: #94a3b8;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .usai-badge {
            color: #144673;
            font-weight: 600;
        }

        .flag {
            font-size: 14px;
        }

        .quick-start-hint {
            font-size: 13px;
            color: #94a3b8;
            font-style: italic;
        }

        .view-card:nth-child(1) { animation-delay: 0.1s; }
        .view-card:nth-child(2) { animation-delay: 0.15s; }
        .view-card:nth-child(3) { animation-delay: 0.2s; }
        .view-card:nth-child(4) { animation-delay: 0.25s; }
        .view-card:nth-child(5) { animation-delay: 0.3s; }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Change View Button */
        .nav-btn {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: var(--orange);
            color: var(--orange);
        }
    </style>
</head>
<body>
    <!-- Welcome Selection Screen -->
    <div id="welcomeScreen" class="welcome-overlay" style="display: none;">
      <div class="welcome-container">
        <div class="welcome-header">
          <h1 class="welcome-title">OneGov FIT Market Intelligence</h1>
          <p class="welcome-subtitle">Select your starting view to begin</p>
        </div>
        
        <div class="view-selection-grid">
          <div class="view-card" data-view="agency">
            <div class="view-icon">üèõÔ∏è</div>
            <h3>Agency View</h3>
            <p>Analyze federal agency procurement data and spending patterns</p>
            <div class="keyboard-hint">1</div>
          </div>
          
          <div class="view-card" data-view="oem">
            <div class="view-icon">üè≠</div>
            <h3>OEM View</h3>
            <p>Explore Original Equipment Manufacturer relationships and contracts</p>
            <div class="keyboard-hint">2</div>
          </div>
          
          <div class="view-card" data-view="vendor">
            <div class="view-icon">ü§ù</div>
            <h3>Vendor View</h3>
            <p>Review vendor performance and reseller distributions</p>
            <div class="keyboard-hint">3</div>
          </div>
          
          <div class="view-card" data-view="reportbuilder">
            <div class="view-icon">üìä</div>
            <h3>Report Builder</h3>
            <p>Create custom reports with advanced visualizations</p>
            <div class="keyboard-hint">4</div>
          </div>
          
          <div class="view-card" data-view="reports">
            <div class="view-icon">üìë</div>
            <h3>Reports</h3>
            <p>Access pre-built reports and saved analyses</p>
            <div class="keyboard-hint">5</div>
          </div>
        </div>
        
        <div class="welcome-footer">
          <div class="powered-by">
            <span>Powered by</span>
            <span class="usai-badge">USAi</span>
            <span class="flag">üá∫üá∏</span>
          </div>
          <div class="quick-start-hint">Click any view to begin ‚Ä¢ Press 1-5 for quick access</div>
        </div>
      </div>
    </div>

    <!-- OneGov FIT Loading Overlay -->
    <div id="oneGovLoadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-logo">
                <div class="logo-circle">
                    <span class="logo-text">OneGov</span>
                    <span class="logo-subtext">FIT</span>
                </div>
            </div>
            <div class="loading-spinner"></div>
            <div class="loading-message" id="loadingMessage">Initializing OneGov FIT Market...</div>
            <div class="loading-progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="loading-subtitle">Federal Information Technology Market Intelligence</div>
        </div>
    </div>

    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                üèõÔ∏è OneGov FIT Market
            </div>
            <ul class="nav-menu">
                <li><a href="#" class="active">üè† Dashboard</a></li>
                <li><a href="#" onclick="openReportBuilder()">üìä Builder</a></li>
                <li><a href="#">üìã Analytics</a></li>
                <li><a href="#">‚öôÔ∏è Settings</a></li>
                <li><button id="changeViewBtn" class="nav-btn" onclick="showViewSelector()" style="display: none;">
                    <span>‚Üª</span> Change View
                </button></li>
                <li><button onclick="resetViewSelection()" class="nav-btn" style="background: #f47920; color: white;">
                    ‚Üª Reset Starting View
                </button></li>
                <li><a href="#" onclick="testAccessLogging()" style="background: #ff6b6b;">üß™ Test Log</a></li>
                <li><a href="#" onclick="simpleTest()" style="background: #00ff00; color: black;">‚úÖ SIMPLE TEST</a></li>
                <li><a href="#" onclick="testEntityLogging()" style="background: #4CAF50; color: white;">üéØ Test Entity</a></li>
                <li><a href="#" onclick="testConnection()" style="background: #2196F3; color: white;">üîå Test Connect</a></li>
            </ul>
        </div>
    </nav>

    <div class="main-container">
        <div class="page-header">
            <h1 class="page-title">OneGov FIT Market Dashboard</h1>
            <p class="page-subtitle">Government Technology Marketplace Analytics & Intelligence Platform</p>
        </div>

        <div id="dashboardApp"></div>
    </div>

    <!-- Functions will be defined in React block -->

    <script type="text/babel">
        // Welcome Screen Handler
        const WelcomeScreen = {
            init: function() {
                console.log('üéØ WelcomeScreen.init called');
                // Show welcome screen on first load
                if (!sessionStorage.getItem('selectedView')) {
                    console.log('üéØ No view selected - showing welcome screen');
                    this.show();
                } else {
                    // If returning user, load their last view
                    const lastView = sessionStorage.getItem('selectedView') || 'agency';
                    console.log('üéØ Returning user - loading last view:', lastView);
                    this.loadView(lastView);
                }
                
                // Attach click handlers using jQuery
                setTimeout(() => {
                    $('.view-card').on('click', function() {
                        const selectedView = $(this).data('view');
                        console.log('üéØ View card clicked:', selectedView);
                        WelcomeScreen.selectView(selectedView);
                    });
                }, 100);
            },

            show: function() {
                console.log('üéØ WelcomeScreen.show called');
                $('#welcomeScreen').show();
                // Hide main content until view selected
                $('#mainContent, .main-container').hide();
                $('#changeViewBtn').hide();
                
                // Check for preferred view
                const preferred = this.getPreferredView();
                if (preferred) {
                    $(`.view-card[data-view="${preferred}"]`).addClass('preferred');
                    $(`.view-card[data-view="${preferred}"]`).append(
                        '<div class="preferred-badge">Recently Used</div>'
                    );
                }
            },
            
            hide: function() {
                console.log('üéØ WelcomeScreen.hide called');
                $('#welcomeScreen').fadeOut(300);
                $('#changeViewBtn').show();
            },

            selectView: function(viewType) {
                console.log('üéØ WelcomeScreen.selectView called with:', viewType);
                // Add selection animation
                $('.view-card').removeClass('selected');
                $(`.view-card[data-view="${viewType}"]`).addClass('selected');
                
                // Store selection and preference
                sessionStorage.setItem('selectedView', viewType);
                this.rememberPreference(viewType);
                
                // Short delay for visual feedback
                setTimeout(() => {
                    this.hide();
                    this.loadView(viewType);
                }, 300);
            },

            loadView: function(viewType) {
                console.log('üéØ WelcomeScreen.loadView called with:', viewType);
                // Show loading with context
                const viewNames = {
                    agency: 'Agency View',
                    oem: 'OEM View', 
                    vendor: 'Vendor View',
                    reportbuilder: 'Report Builder',
                    reports: 'Reports'
                };
                
                LoadingManager.show(`Loading ${viewNames[viewType]}...`, 3000, 'view');
                
                // Show main content
                $('#mainContent, .main-container').fadeIn(500);
                
                // Load the specific view and start React
                setTimeout(() => {
                    this.startReactApp(viewType);
                }, 500);
            },

            startReactApp: function(viewType) {
                console.log('üéØ Starting React app with view:', viewType);
                // Set the initial filter based on view type
                if (viewType && viewType !== 'reportbuilder' && viewType !== 'reports') {
                    window.initialViewType = viewType;
                }
                
                // Start React app
                const root = ReactDOM.createRoot(document.getElementById('dashboardApp'));
                root.render(<DashboardApp />);
                
                // Hide loading after React renders
                setTimeout(() => {
                    LoadingManager.hide();
                }, 2000);
            },

            rememberPreference: function(viewType) {
                localStorage.setItem('preferredView', viewType);
                localStorage.setItem('preferredViewTimestamp', Date.now());
            },

            getPreferredView: function() {
                const preferred = localStorage.getItem('preferredView');
                const timestamp = localStorage.getItem('preferredViewTimestamp');

                // Only use preference if less than 7 days old
                if (preferred && timestamp) {
                    const daysSince = (Date.now() - parseInt(timestamp)) / (1000 * 60 * 60 * 24);
                    if (daysSince < 7) {
                        return preferred;
                    }
                }
                return null;
            }
        };

        // Global function for Change View button
        window.showViewSelector = function() {
            if (confirm('Return to view selection? Current work will be preserved.')) {
                sessionStorage.removeItem('selectedView');
                WelcomeScreen.show();
            }
        };

        // Reset view selection function
        window.resetViewSelection = function() {
            sessionStorage.removeItem('selectedView');
            location.reload(); // This will show selection screen again
        };

        // View-specific loading functions for more granular control
        function loadAgencyData() {
            console.log('üèõÔ∏è Loading Agency data...');
            window.initialViewType = 'agency';
            const root = ReactDOM.createRoot(document.getElementById('dashboardApp'));
            root.render(<DashboardApp />);
        }

        function loadOEMData() {
            console.log('üè≠ Loading OEM data...');
            window.initialViewType = 'oem';
            const root = ReactDOM.createRoot(document.getElementById('dashboardApp'));
            root.render(<DashboardApp />);
        }

        function loadVendorData() {
            console.log('ü§ù Loading Vendor data...');
            window.initialViewType = 'vendor';
            const root = ReactDOM.createRoot(document.getElementById('dashboardApp'));
            root.render(<DashboardApp />);
        }

        function initializeReportBuilder() {
            console.log('üìä Initializing Report Builder...');
            // Could redirect to report builder page or load specific components
            openReportBuilder();
        }

        function loadReportsView() {
            console.log('üìë Loading Reports view...');
            // Could load reports-specific React component or redirect
            window.initialViewType = 'reports';
            const root = ReactDOM.createRoot(document.getElementById('dashboardApp'));
            root.render(<DashboardApp />);
        }

        // Keyboard shortcuts for power users
        document.addEventListener('keydown', function(e) {
            // Only work on welcome screen
            if ($('#welcomeScreen').is(':visible')) {
                switch(e.key) {
                    case '1':
                        WelcomeScreen.selectView('agency');
                        break;
                    case '2':
                        WelcomeScreen.selectView('oem');
                        break;
                    case '3':
                        WelcomeScreen.selectView('vendor');
                        break;
                    case '4':
                        WelcomeScreen.selectView('reportbuilder');
                        break;
                    case '5':
                        WelcomeScreen.selectView('reports');
                        break;
                }
            }
        });

        // Show initial loader when page starts loading  
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOM loaded - initializing welcome screen');
            
            // Initialize welcome screen first - this controls React loading
            WelcomeScreen.init();
            
            // DO NOT auto-start React here - let WelcomeScreen control it
        });

        // Loading Manager for OneGov FIT (same as F02)
        const LoadingManager = {
            startTime: null,
            estimatedDuration: 3000,
            progressInterval: null,
            context: 'data',

            show: function(message, estimatedMs = 3000, context = 'data') {
                this.context = context;
                this.startTime = Date.now();
                this.estimatedDuration = estimatedMs;
                
                const overlay = document.getElementById('oneGovLoadingOverlay');
                const messageEl = document.getElementById('loadingMessage');
                const progressBar = document.getElementById('progressBar');

                if (overlay) {
                    overlay.style.display = 'flex';
                    messageEl.textContent = message || 'Processing...';
                    progressBar.style.width = '0%';
                }
                
                const progressMessages = {
                    init: ['Initializing system...', 'Loading configurations...', 'Connecting to database...', 'Preparing interface...'],
                    entity: ['Loading entity data...', 'Fetching relationships...', 'Building visualizations...', 'Rendering charts...'],
                    view: ['Switching view...', 'Loading components...', 'Preparing layout...', 'Finalizing display...'],
                    data: ['Connecting to database...', 'Fetching records...', 'Processing data...', 'Finalizing visualizations...']
                };

                const messages = progressMessages[context] || progressMessages.data;
                let messageIndex = 0;

                this.progressInterval = setInterval(() => {
                    const elapsed = Date.now() - this.startTime;
                    const progress = Math.min((elapsed / this.estimatedDuration) * 100, 95);
                    progressBar.style.width = progress + '%';

                    // Update message every 25% progress
                    const newMessageIndex = Math.floor(progress / 25);
                    if (newMessageIndex !== messageIndex && newMessageIndex < messages.length) {
                        messageIndex = newMessageIndex;
                        messageEl.textContent = messages[messageIndex];
                    }

                    if (progress >= 95) {
                        clearInterval(this.progressInterval);
                    }
                }, 100);
            },

            hide: function() {
                const overlay = document.getElementById('oneGovLoadingOverlay');
                const progressBar = document.getElementById('progressBar');
                
                if (overlay && this.progressInterval) {
                    // Complete the progress bar
                    progressBar.style.width = '100%';
                    
                    setTimeout(() => {
                        overlay.style.display = 'none';
                        progressBar.style.width = '0%';
                        clearInterval(this.progressInterval);
                        this.progressInterval = null;
                    }, 200);
                }
            }
        };

        // Global navigation function
        function navigateWithLoading(action, message, duration = 3000) {
            LoadingManager.show(message, duration, action);
            return new Promise((resolve) => {
                setTimeout(() => {
                    LoadingManager.hide();
                    resolve();
                }, 300);
            });
        }

        const { useState, useEffect } = React;

        console.log('React script starting...');
        
        // Test if google.script.run is available
        if (typeof google !== 'undefined' && google.script && google.script.run) {
            console.log('‚úÖ google.script.run is available');
            
            // Immediate test on page load
            console.log('üîç Testing direct logging call...');
            google.script.run
                .withSuccessHandler((result) => {
                    console.log('‚úÖ Direct test success:', result);
                })
                .withFailureHandler((error) => {
                    console.error('‚ùå Direct test failed:', error);
                    console.error('Error details:', error.message, error.stack);
                })
                .testEntityAccess();
        } else {
            console.error('‚ùå google.script.run is NOT available');
            console.log('Window object:', window);
            console.log('Google object:', typeof google !== 'undefined' ? google : 'undefined');
        }
        window.formatCurrencyShort = function(value) {
            if (value === null || value === undefined || isNaN(value)) return '$0';
            
            const absValue = Math.abs(value);
            const sign = value < 0 ? '-' : '';
            
            if (absValue >= 1000000000) {
                return sign + '$' + (absValue / 1000000000).toFixed(1) + 'B';
            } else if (absValue >= 1000000) {
                return sign + '$' + (absValue / 1000000).toFixed(1) + 'M';
            } else if (absValue >= 1000) {
                return sign + '$' + (absValue / 1000).toFixed(1) + 'K';
            } else {
                return sign + '$' + absValue.toFixed(0);
            }
        };
        
        // Make formatCurrencyShort available globally for both React and non-React code
        const formatCurrencyShort = window.formatCurrencyShort;
        
        // Entity Detail Modal Functions
        window.showEntityDetail = function(entity, entityIndex) {
            console.log('üîç DEBUG: showEntityDetail called');
            console.log('üîç DEBUG: Entity name:', entity?.name);
            console.log('üîç DEBUG: Full entity object:', entity);
            
            // First test if google.script.run is available
            console.log('üîç DEBUG: google.script.run available?', typeof google?.script?.run);
            
            // Log access based on entity type
            if (entity && entity.type) {
                const entityType = entity.type.toLowerCase();
                
                if (entityType === 'oem') {
                    console.log('üìä Attempting to log OEM access...');
                    google.script.run
                        .withSuccessHandler((result) => console.log('‚úÖ OEM access logged successfully:', result))
                        .withFailureHandler((error) => console.error('‚ùå OEM access logging failed:', error))
                        .logOEMAccess();
                } else if (entityType === 'agency') {
                    console.log('üìä Attempting to log Agency access...');
                    google.script.run
                        .withSuccessHandler((result) => console.log('‚úÖ Agency access logged successfully:', result))
                        .withFailureHandler((error) => console.error('‚ùå Agency access logging failed:', error))
                        .logAgencyAccess();
                } else if (entityType === 'vendor') {
                    console.log('üìä Attempting to log Vendor access...');
                    google.script.run
                        .withSuccessHandler((result) => console.log('‚úÖ Vendor access logged successfully:', result))
                        .withFailureHandler((error) => console.error('‚ùå Vendor access logging failed:', error))
                        .logVendorAccess();
                }
            }
            
            // Store entity data for report generation
            window.currentEntityData = entity;
            
            // Process USAi profile data
            const profileData = processUSAiProfile(entity);
            console.log('üîç DEBUG: Profile data processed:', profileData);
            
            // Process entity data for charts
            const entityData = processEntityData(entity);
            console.log('üîç DEBUG: Entity data processed:', entityData);
            
            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'modal-overlay';
            
            // Generate modal HTML
            const modalHTML = createEntityModalHTML(entity, entityData, profileData);
            console.log('üîç DEBUG: Modal HTML length:', modalHTML.length);
            console.log('üîç DEBUG: Modal HTML includes "Get Profiles":', modalHTML.includes('Get Profiles'));
            modalOverlay.innerHTML = modalHTML;
            
            // Add to page
            document.body.appendChild(modalOverlay);
            console.log('üîç DEBUG: Modal added to DOM');
            
            // Check if button exists
            const profileButton = modalOverlay.querySelector('.report-dropdown-btn');
            console.log('üîç DEBUG: Profile button found:', !!profileButton);
            if (profileButton) {
                console.log('üîç DEBUG: Profile button onclick:', profileButton.onclick);
            }
            
            // Add click outside to close
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    modalOverlay.remove();
                }
            });
        };
        
        function createEntityModalHTML(entity, entityData, profileData) {
            return `
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="header-container">
                            <div class="entity-info">
                                <h1>${entity.name}</h1>
                                <div class="entity-meta">
                                    <span>Total Obligations: ${formatCurrencyShort(entity.totalObligations || 0)}</span>
                                </div>
                            </div>
                            <button class="close-btn" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                        </div>
                    </div>
                    
                    <div class="content-container">
                        <div class="section">
                            <h2 class="section-title">${entity.type?.toUpperCase() || 'Entity'} Profile</h2>
                            <div class="profile-card">
                                <div class="profile-header">
                                    <div>
                                        <h3 class="profile-title">${entity.name}</h3>
                                        <div class="profile-meta">
                                            ${entity.tier ? `<span class="tier-badge">${entity.tier}</span>` : ''}
                                        </div>
                                    </div>
                                    <div class="action-links">
                                        ${profileData.website ? `
                                        <a href="${profileData.website.startsWith('http') ? profileData.website : 'https://' + profileData.website}" 
                                           target="_blank" 
                                           rel="noopener noreferrer"
                                           class="action-link website-link">
                                            üåê Website
                                        </a>` : ''}
                                        ${profileData.linkedin ? `
                                        <a href="${profileData.linkedin.startsWith('http') ? profileData.linkedin : 'https://' + profileData.linkedin}" 
                                           target="_blank" 
                                           rel="noopener noreferrer"
                                           class="action-link linkedin-link">
                                            üíº LinkedIn
                                        </a>` : ''}
                                        <button class="action-link report-dropdown-btn" onclick="openProfileSelector()">
                                            üìÑ Get Profiles
                                        </button>
                                    </div>
                                </div>
                                <div class="overview-text">
                                    ${profileData.overview || `${entity.name} is a ${entity.type?.toLowerCase() || 'organization'} with ${formatCurrencyShort(entity.totalObligations || 0)} in total government obligations.`}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function processUSAiProfile(entity) {
            if (!entity) return { website: '', linkedin: '', overview: '' };
            
            const website = entity.website || entity.usaiProfile?.website || '';
            const linkedin = entity.linkedin || entity.usaiProfile?.linkedin || '';
            const overview = entity.usaiProfile?.overview || '';
            
            return {
                website: website,
                linkedin: linkedin,
                overview: overview
            };
        }
        
        function processEntityData(entity) {
            return {
                totalObligations: entity.totalObligations || 0
            };
        }
        
        window.openProfileSelector = function() {
            const entity = window.currentEntityData;
            if (!entity) {
                alert('No entity data available');
                return;
            }
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.6); z-index: 10000; display: flex;
                align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 0; max-width: 450px; width: 90%; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <div style="background: linear-gradient(135deg, #0a2240 0%, #144673 100%); color: white; padding: 20px 24px;">
                        <h3 style="margin: 0; font-size: 1.2rem;">üìÑ Generate Profile for ${entity.name}</h3>
                    </div>
                    <div style="padding: 24px;">
                        <p style="margin: 0 0 20px 0; color: #666;">Select a profile type:</p>
                        
                        <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 24px;">
                            <button onclick="selectProfileType('Executive Profile')" style="padding: 16px; background: #f8f9fa; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; text-align: left; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #0a2240;">üìã Executive Profile</div>
                                    <div style="font-size: 0.8rem; color: #666;">One-page summary with key metrics</div>
                                </div>
                                <span style="background: #dcfce7; color: #166534; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">READY</span>
                            </button>
                            
                            <button onclick="showComingSoon('Product Report')" style="padding: 16px; background: #fafafa; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; text-align: left; opacity: 0.7; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #0a2240;">üìä Product Report</div>
                                    <div style="font-size: 0.8rem; color: #666;">Product and service analysis</div>
                                </div>
                                <span style="background: #fef3c7; color: #92400e; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">IN DEV</span>
                            </button>
                            
                            <button onclick="showComingSoon('Contract Summary')" style="padding: 16px; background: #fafafa; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; text-align: left; opacity: 0.7; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #0a2240;">üìë Contract Summary</div>
                                    <div style="font-size: 0.8rem; color: #666;">Contract and procurement overview</div>
                                </div>
                                <span style="background: #fef3c7; color: #92400e; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">IN DEV</span>
                            </button>
                        </div>
                        
                        <div style="text-align: center;">
                            <button onclick="closeProfileModal()" style="padding: 10px 28px; background: #e5e7eb; color: #333; border: none; border-radius: 6px; cursor: pointer; font-size: 0.95rem;">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.profileModal = modal;
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeProfileModal();
            });
        };
        
        window.closeProfileModal = function() {
            if (window.profileModal) {
                window.profileModal.remove();
                window.profileModal = null;
            }
        };
        
        window.selectProfileType = function(profileType) {
            closeProfileModal();
            
            if (profileType === 'Executive Profile') {
                // Show letterhead selection modal
                showLetterheadSelection(profileType);
            } else {
                showComingSoon(profileType);
            }
        };
        
        window.showComingSoon = function(profileType) {
            closeProfileModal();
            alert(`${profileType} is coming soon!\n\nThis profile type is currently in development.`);
        };
        
        // Show letterhead selection modal
        window.showLetterheadSelection = function(profileType) {
            const entity = window.currentEntityData;
            if (!entity) {
                alert('No entity data available');
                return;
            }
            
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10001; animation: fadeIn 0.2s;';
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 0; max-width: 450px; width: 90%; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <div style="background: linear-gradient(135deg, #0a2240 0%, #144673 100%); color: white; padding: 20px 24px;">
                        <h3 style="margin: 0; font-size: 1.2rem;">üé® Select Letterhead</h3>
                    </div>
                    <div style="padding: 24px;">
                        <p style="margin: 0 0 20px 0; color: #666;">Choose letterhead for ${profileType}:</p>
                        
                        <div style="display: flex; gap: 12px; margin-bottom: 24px;">
                            <button onclick="generateProfile('${profileType}', 'GSA')" style="flex: 1; padding: 20px; background: #0a2240; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s;" onmouseover="this.style.background='#144673'" onmouseout="this.style.background='#0a2240'">
                                GSA
                                <div style="font-size: 0.75rem; font-weight: 400; margin-top: 4px;">General Services Admin</div>
                            </button>
                            <button onclick="generateProfile('${profileType}', 'ITVMO')" style="flex: 1; padding: 20px; background: #1a472a; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s;" onmouseover="this.style.background='#2e5a3e'" onmouseout="this.style.background='#1a472a'">
                                ITVMO
                                <div style="font-size: 0.75rem; font-weight: 400; margin-top: 4px;">IT Vendor Management</div>
                            </button>
                        </div>
                        
                        <div style="text-align: center;">
                            <button onclick="closeLetterheadModal()" style="padding: 10px 28px; background: #e5e7eb; color: #333; border: none; border-radius: 6px; cursor: pointer; font-size: 0.95rem;">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.letterheadModal = modal;
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeLetterheadModal();
            });
        };
        
        // Close letterhead modal
        window.closeLetterheadModal = function() {
            if (window.letterheadModal) {
                window.letterheadModal.remove();
                window.letterheadModal = null;
            }
        };
        
        // Check if google.script.run exists
        window.checkGoogleScriptRun = function() {
            console.log('Checking google.script.run...');
            console.log('typeof google:', typeof window.google);
            console.log('google exists:', !!window.google);
            console.log('google.script exists:', !!window.google?.script);
            console.log('google.script.run exists:', !!window.google?.script?.run);
            console.log('Window location:', window.location.href);
            console.log('Parent window:', window.parent !== window);
            
            if (!window.google?.script?.run) {
                alert('‚ùå google.script.run is not available in this context!\nLocation: ' + window.location.href);
                return false;
            } else {
                alert('‚úÖ google.script.run is available!');
                return true;
            }
        };

        // Simple test function
        window.testSimple = function() {
            console.log('Testing simple function...');
            
            if (!window.checkGoogleScriptRun()) {
                return;
            }
            
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('‚úÖ Simple test SUCCESS:', result);
                    alert('Simple test worked! Result: ' + result);
                })
                .withFailureHandler(function(error) {
                    console.error('‚ùå Simple test FAILED:', error);
                    alert('Simple test failed: ' + error.message);
                })
                .testSimple();
        };

        // Minimal HTML test
        window.testMinimal = function() {
            console.log('Testing minimal HTML...');
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('‚úÖ Minimal HTML test SUCCESS:', result);
                    if (result && result.html) {
                        alert('Minimal HTML test worked! HTML length: ' + result.html.length);
                    } else {
                        alert('Minimal HTML test failed: no HTML returned');
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('‚ùå Minimal HTML test FAILED:', error);
                    alert('Minimal HTML test failed: ' + error.message);
                })
                .testMinimalHTML();
        };

        // Test function
        window.testProfile = function() {
            console.log('Testing profile generation...');
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('Test success:', result);
                    if (result && result.html) {
                        // Show in simple modal
                        const modal = document.createElement('div');
                        modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';
                        modal.innerHTML = `
                            <div style="background: white; padding: 20px; border-radius: 8px; max-width: 500px;">
                                ${result.html}
                                <button onclick="this.closest('[style*=fixed]').remove()" style="margin-top: 15px; padding: 5px 15px; background: #dc3545; color: white; border: none; border-radius: 4px;">Close</button>
                            </div>
                        `;
                        document.body.appendChild(modal);
                    } else {
                        alert('Test failed: no HTML returned');
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Test failed:', error);
                    alert('Test failed: ' + error.message);
                })
                .testProfileGeneration();
        };

        // Generate profile function
        window.generateProfile = function(profileType, letterhead) {
            closeLetterheadModal();
            
            const entity = window.currentEntityData;
            if (!entity) {
                alert('No entity data available');
                return;
            }
            
            // Show OneGov FIT loading
            LoadingManager.show(`Generating ${profileType} for ${entity.name}...`, 10000, 'data');
            
            // Call backend to generate profile
            console.log('Calling backend with entity:', entity.name, 'letterhead:', letterhead);
            
            google.script.run
                .withSuccessHandler(function(result) {
                    LoadingManager.hide();
                    console.log('‚úÖ Success handler called');
                    console.log('Full result object:', result);
                    console.log('Result type:', typeof result);
                    console.log('Result keys:', result ? Object.keys(result) : 'null');
                    console.log('Result.success:', result?.success);
                    console.log('Result.html exists:', !!result?.html);
                    console.log('HTML length:', result?.html ? result.html.length : 0);
                    console.log('First 200 chars of HTML:', result?.html ? result.html.substring(0, 200) : 'no html');
                    
                    if (!result) {
                        alert('No response from server');
                        return;
                    }
                    
                    if (result.error) {
                        alert('Error: ' + result.error);
                        return;
                    }
                    
                    if (result.html) {
                        console.log('Attempting to display HTML...');
                        
                        // Try method 1: Direct write to new window
                        try {
                            const newWindow = window.open('about:blank', '_blank');
                            if (newWindow) {
                                newWindow.document.open();
                                newWindow.document.write(result.html);
                                newWindow.document.close();
                                console.log('‚úÖ HTML written to new window');
                            } else {
                                throw new Error('Popup blocked');
                            }
                        } catch (e) {
                            console.error('Failed to open new window:', e);
                            
                            // Method 2: Show in iframe modal
                            const modal = document.createElement('div');
                            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';
                            
                            const container = document.createElement('div');
                            container.style.cssText = 'width: 90%; max-width: 1200px; height: 90vh; background: white; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column;';
                            
                            const header = document.createElement('div');
                            header.style.cssText = 'padding: 15px; background: #f8f9fa; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center;';
                            header.innerHTML = `
                                <h3 style="margin: 0;">Executive Profile - ${entity.name}</h3>
                                <button onclick="this.closest('[style*=fixed]').remove()" style="background: #dc3545; color: white; border: none; padding: 5px 15px; border-radius: 4px; cursor: pointer;">Close</button>
                            `;
                            
                            const iframe = document.createElement('iframe');
                            iframe.style.cssText = 'flex: 1; width: 100%; border: none;';
                            iframe.srcdoc = result.html;
                            
                            container.appendChild(header);
                            container.appendChild(iframe);
                            modal.appendChild(container);
                            document.body.appendChild(modal);
                            
                            console.log('‚úÖ HTML displayed in modal iframe');
                        }
                    } else {
                        console.error('No HTML in result');
                        alert('No HTML content generated. Check console for details.');
                    }
                })
                .withFailureHandler(function(error) {
                    LoadingManager.hide();
                    alert('Error: ' + error.message);
                })
                .generateExecutiveProfileDirect(entity, letterhead);
        };
        
        // Show profile preview
        window.showProfilePreview = function(html, profileType, letterhead) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 10002; padding: 20px;';
            
            const container = document.createElement('div');
            container.style.cssText = 'background: white; width: 100%; max-width: 900px; height: 90vh; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column;';
            
            container.innerHTML = `
                <div style="background: linear-gradient(135deg, #0a2240 0%, #144673 100%); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0; font-size: 1.1rem;">${profileType} Preview - ${letterhead}</h3>
                    <button onclick="closePreviewModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer;">‚úï Close</button>
                </div>
                <div style="flex: 1; overflow: auto; padding: 20px;">
                    ${html}
                </div>
                <div style="padding: 15px; background: #f8f9fa; border-top: 1px solid #dee2e6; text-align: center;">
                    <button onclick="generateFinalDocument('${profileType}', '${letterhead}')" style="background: #f47920; color: white; border: none; padding: 10px 30px; border-radius: 6px; font-size: 1rem; font-weight: 600; cursor: pointer;">üìÑ Generate Document</button>
                </div>
            `;
            
            modal.appendChild(container);
            document.body.appendChild(modal);
            window.previewModal = modal;
        };
        
        // Close preview modal
        window.closePreviewModal = function() {
            if (window.previewModal) {
                window.previewModal.remove();
                window.previewModal = null;
            }
        };
        
        // Generate final document
        window.generateFinalDocument = function(profileType, letterhead) {
            closePreviewModal();
            generateProfile(profileType, letterhead);
        };
        
        // Make showEntityDetail available to React
        const showEntityDetail = window.showEntityDetail;
        
        console.log('‚úÖ Entity detail functions loaded in React:');
        console.log('  - showEntityDetail:', typeof window.showEntityDetail);
        console.log('  - openProfileSelector:', typeof window.openProfileSelector);
        console.log('  - closeProfileModal:', typeof window.closeProfileModal);
        console.log('  - selectProfileType:', typeof window.selectProfileType);
        console.log('  - showComingSoon:', typeof window.showComingSoon);

        // Global entities storage
        let currentEntities = [];
        
        // Main Dashboard Component
        const DashboardApp = () => {
            const [entities, setEntities] = useState([]);
            const [filteredEntities, setFilteredEntities] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [filters, setFilters] = useState({
                type: window.initialViewType || '',
                search: '',
                minObligation: '',
                maxObligation: ''
            });

            // Load initial data
            useEffect(() => {
                console.log('üöÄ React component mounted - starting data load');
                console.log('üöÄ Initial view type:', window.initialViewType);
                loadEntities();
            }, []);

            // Apply filters when they change
            useEffect(() => {
                applyFilters();
            }, [entities, filters]);

            const loadEntities = async () => {
                setLoading(true);
                setError('');
                
                console.log('üîÑ LoadEntities started - ensuring loading overlay is visible');
                
                // Make sure loading overlay is visible and update message
                const overlay = document.getElementById('oneGovLoadingOverlay');
                const messageEl = document.getElementById('loadingMessage');
                
                if (overlay && overlay.style.display !== 'flex') {
                    console.log('‚ö° Loading overlay was hidden - showing it now');
                    LoadingManager.show('Loading market intelligence data...', 30000, 'data');
                } else if (messageEl) {
                    console.log('üîÑ Updating loading message to data phase');
                    messageEl.textContent = 'Loading market intelligence data...';
                }
                
                try {
                    const data = await callGoogleScript('getAllEntities');
                    if (data && Array.isArray(data)) {
                        setEntities(data);
                        currentEntities = data;
                        
                        // Update message to show completion
                        if (messageEl) {
                            messageEl.textContent = 'Rendering entity cards...';
                        }
                        
                        // Wait longer to ensure cards are rendered
                        setTimeout(() => {
                            console.log('‚úÖ Data loaded and cards rendered - hiding loading overlay');
                            setLoading(false); // Set loading false just before hiding overlay
                            LoadingManager.hide();
                        }, 2000);
                    } else {
                        setError('No entity data available');
                        setLoading(false);
                        LoadingManager.hide();
                    }
                } catch (err) {
                    console.error('Error loading entities:', err);
                    setError('Failed to load entity data: ' + err.message);
                    setLoading(false);
                    LoadingManager.hide();
                } finally {
                    // Don't set loading false here, do it in success/error blocks
                }
            };

            const applyFilters = () => {
                let filtered = [...entities];

                // Type filter
                if (filters.type) {
                    filtered = filtered.filter(entity => 
                        entity.type && entity.type.toLowerCase().includes(filters.type.toLowerCase())
                    );
                }

                // Search filter
                if (filters.search) {
                    filtered = filtered.filter(entity =>
                        entity.name && entity.name.toLowerCase().includes(filters.search.toLowerCase())
                    );
                }

                // Obligation range filters
                if (filters.minObligation) {
                    const min = parseFloat(filters.minObligation);
                    filtered = filtered.filter(entity => 
                        entity.totalObligations && entity.totalObligations >= min
                    );
                }

                if (filters.maxObligation) {
                    const max = parseFloat(filters.maxObligation);
                    filtered = filtered.filter(entity => 
                        entity.totalObligations && entity.totalObligations <= max
                    );
                }

                setFilteredEntities(filtered);
            };

            const updateFilter = (key, value) => {
                console.log(`üîÑ updateFilter called: key=${key}, value=${value}`);
                setFilters(prev => ({ ...prev, [key]: value }));
                
                // Log view access when entity type filter changes
                if (key === 'type' && value) {
                    const viewName = value.charAt(0).toUpperCase() + value.slice(1);
                    console.log(`üìä Logging view change to: ${viewName}`);
                    
                    try {
                        if (value === 'oem') {
                            console.log('üöÄ Calling logOEMAccess...');
                            google.script.run
                                .withSuccessHandler((result) => {
                                    console.log('‚úÖ OEM view logged:', result);
                                    alert('OEM view logged successfully');
                                })
                                .withFailureHandler((error) => {
                                    console.error('‚ùå OEM view logging failed:', error);
                                    alert(`Failed to log OEM view: ${error}`);
                                })
                                .logOEMAccess();
                        } else if (value === 'agency') {
                            console.log('üöÄ Calling logAgencyAccess...');
                            google.script.run
                                .withSuccessHandler((result) => {
                                    console.log('‚úÖ Agency view logged:', result);
                                    alert('Agency view logged successfully');
                                })
                                .withFailureHandler((error) => {
                                    console.error('‚ùå Agency view logging failed:', error);
                                    alert(`Failed to log Agency view: ${error}`);
                                })
                                .logAgencyAccess();
                        } else if (value === 'vendor') {
                            console.log('üöÄ Calling logVendorAccess...');
                            google.script.run
                                .withSuccessHandler((result) => {
                                    console.log('‚úÖ Vendor view logged:', result);
                                    alert('Vendor view logged successfully');
                                })
                                .withFailureHandler((error) => {
                                    console.error('‚ùå Vendor view logging failed:', error);
                                    alert(`Failed to log Vendor view: ${error}`);
                                })
                                .logVendorAccess();
                        }
                    } catch (err) {
                        console.error('‚ùå Exception in view logging:', err);
                        alert(`Exception: ${err.message}`);
                    }
                }
            };

            const openEntityDetail = (entityIndex) => {
                console.log('üéØ openEntityDetail called with index:', entityIndex);
                const entity = filteredEntities[entityIndex];
                console.log('üéØ Entity found:', entity);
                if (!entity) {
                    console.error('‚ùå No entity found at index:', entityIndex);
                    return;
                }

                // Log entity access
                const entityName = entity.name || entity.contractor || 'Unknown';
                const entityType = entity.type || filters.type || 'Unknown';
                
                console.log(`üìä Logging entity card click: ${entityName} (${entityType})`);
                console.log('Entity data:', entity);
                console.log('Current filter type:', filters.type);
                
                // Capitalize entity type for logging
                const logType = entityType.charAt(0).toUpperCase() + entityType.slice(1).toLowerCase();
                
                // Try logging with explicit error handling
                try {
                    console.log('üöÄ Attempting to call logEntityAccess...');
                    google.script.run
                        .withSuccessHandler((result) => {
                            console.log('‚úÖ Entity access logged:', result);
                            alert(`SUCCESS: Logged ${entityName}`);
                        })
                        .withFailureHandler((error) => {
                            console.error('‚ùå Entity access logging failed:', error);
                            alert(`ERROR: Failed to log ${entityName}: ${error}`);
                        })
                        .logEntityAccess(entityName, logType);
                    console.log('üì§ logEntityAccess call sent');
                } catch (err) {
                    console.error('‚ùå Exception calling logEntityAccess:', err);
                    alert(`EXCEPTION: ${err.message}`);
                }

                // Import and use the entity detail modal
                showEntityDetail(entity, entityIndex);
            };

            return (
                <>
                    {/* Control Panel */}
                    <div className="control-panel">
                        <div className="control-row">
                            <div className="control-group">
                                <label className="control-label">Entity Type</label>
                                <select 
                                    className="control-input"
                                    value={filters.type}
                                    onChange={(e) => {
                                        const value = e.target.value;
                                        updateFilter('type', value);
                                        
                                        // Log view change directly here
                                        if (value) {
                                            console.log('Logging view change:', value);
                                            const viewName = value.charAt(0).toUpperCase() + value.slice(1);
                                            google.script.run
                                                .withSuccessHandler((result) => {
                                                    console.log('‚úÖ View logged:', result);
                                                })
                                                .withFailureHandler((error) => {
                                                    console.error('‚ùå Failed to log view:', error);
                                                })
                                                .logUserAccess(viewName);
                                        }
                                    }}
                                >
                                    <option value="">All Types</option>
                                    <option value="agency">Agency</option>
                                    <option value="oem">OEM</option>
                                    <option value="vendor">Vendor</option>
                                </select>
                            </div>

                            <div className="control-group">
                                <label className="control-label">Search</label>
                                <input 
                                    type="text"
                                    className="control-input"
                                    placeholder="Search entities..."
                                    value={filters.search}
                                    onChange={(e) => updateFilter('search', e.target.value)}
                                />
                            </div>

                            <div className="control-group">
                                <label className="control-label">Min Obligation ($M)</label>
                                <input 
                                    type="number"
                                    className="control-input"
                                    placeholder="0"
                                    value={filters.minObligation}
                                    onChange={(e) => updateFilter('minObligation', e.target.value)}
                                />
                            </div>

                            <div className="control-group">
                                <label className="control-label">Max Obligation ($M)</label>
                                <input 
                                    type="number"
                                    className="control-input"
                                    placeholder="1000"
                                    value={filters.maxObligation}
                                    onChange={(e) => updateFilter('maxObligation', e.target.value)}
                                />
                            </div>

                            <button className="btn btn-primary" onClick={loadEntities}>
                                üîÑ Refresh Data
                            </button>
                        </div>
                    </div>

                    {/* Entities Section */}
                    <div className="entities-container">
                        <div className="entities-header">
                            <h2 className="entities-title">Government Technology Entities</h2>
                            <div className="entities-count">
                                Showing {filteredEntities.length} of {entities.length} entities
                            </div>
                        </div>

                        {/* Loading state handled by OneGov loading overlay */}

                        {error && (
                            <div className="error">
                                {error}
                            </div>
                        )}

                        {!loading && !error && (
                            <div className="entities-grid">
                                {filteredEntities.map((entity, index) => (
                                    <div 
                                        key={entity.name || index}
                                        className="entity-card"
                                        onClick={() => {
                                            const entity = filteredEntities[index];
                                            const entityName = entity.name || entity.contractor || 'Unknown';
                                            const entityType = entity.type || filters.type || 'Unknown';
                                            
                                            // Log the entity access RIGHT HERE
                                            console.log('Logging entity access:', entityName, entityType);
                                            
                                            // Test if google.script.run is available at this point
                                            if (typeof google !== 'undefined' && google.script && google.script.run) {
                                                console.log('google.script.run is available, calling logEntityAccess...');
                                                try {
                                                    google.script.run
                                                        .withSuccessHandler((result) => {
                                                            console.log('‚úÖ Entity logged:', result);
                                                        })
                                                        .withFailureHandler((error) => {
                                                            console.error('‚ùå Failed to log entity:', error);
                                                        })
                                                        .logEntityAccess(entityName, entityType.charAt(0).toUpperCase() + entityType.slice(1).toLowerCase());
                                                } catch (e) {
                                                    console.error('Exception calling logEntityAccess:', e);
                                                }
                                            } else {
                                                console.error('google.script.run NOT available in onClick handler!');
                                            }
                                            
                                            // Then open the detail modal
                                            openEntityDetail(index);
                                        }}
                                    >
                                        <div className="entity-name">{entity.name || 'Unknown Entity'}</div>
                                        <div className="entity-type">
                                            {entity.type?.toUpperCase() || 'ENTITY'}
                                        </div>
                                        
                                        <div className="entity-stats">
                                            <div className="stat">
                                                <div className="stat-value">
                                                    {formatCurrencyShort(entity.totalObligations || 0)}
                                                </div>
                                                <div className="stat-label">Total Obligations</div>
                                            </div>
                                            <div className="stat">
                                                <div className="stat-value">
                                                    {entity.contractCount || 0}
                                                </div>
                                                <div className="stat-label">Contracts</div>
                                            </div>
                                        </div>
                                        
                                        {entity.tier && (
                                            <div style={{ 
                                                marginTop: '0.5rem', 
                                                padding: '0.25rem 0.5rem', 
                                                background: 'var(--green)', 
                                                color: 'white', 
                                                borderRadius: '4px', 
                                                fontSize: '0.8rem', 
                                                textAlign: 'center',
                                                fontWeight: '600'
                                            }}>
                                                {entity.tier}
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}

                        {!loading && !error && filteredEntities.length === 0 && (
                            <div className="loading">
                                No entities found matching your criteria
                            </div>
                        )}
                    </div>
                </>
            );
        };

        // Utility function for API calls
        const callGoogleScript = (functionName, ...params) => {
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(reject)
                    [functionName](...params);
            });
        };

        // Open report builder function
          const openReportBuilder = () => {
          // Show loading
          LoadingManager.show('Opening Report Builder...', 3000, 'view');
          
          // 1. First, log the access
          google.script.run
            .withSuccessHandler(() => {
              console.log("Log success, now getting URL...");
              // 2. ONLY AFTER logging succeeds, ask for the URL
              google.script.run
                .withSuccessHandler(url => {
                  if (url) {
                    // Add brief delay before navigation for smooth transition
                    setTimeout(() => {
                      window.location.href = url;
                    }, 300);
                  } else {
                    LoadingManager.hide();
                  }
                })
                .withFailureHandler(error => {
                  console.error('Error getting Report Builder URL:', error);
                  LoadingManager.hide();
                })
                .getReportBuilderUrl();
            })
            .withFailureHandler(err => {
              console.error("Log failed, but proceeding anyway...");
              // 3. Even if log fails, still try to get the URL so user isn't stuck
              google.script.run
                .withSuccessHandler(url => {
                  if (url) window.location.href = url;
                })
                .getReportBuilderUrl();
            })
            .logReportGeneratorAccess();
        }


        // Log dashboard access when page loads
        if (window.google?.script?.run) {
            google.script.run
                .withSuccessHandler((result) => {
                    // Silent success
                })
                .withFailureHandler((error) => {
                    console.error('Dashboard access logging failed:', error);
                })
                .logAppAccess();
        }
        
        // Add test button for debugging
        window.testAccessLogging = function() {
            console.log('üß™ Testing access logging...');
            google.script.run
                .withSuccessHandler((result) => {
                    console.log('‚úÖ Test result:', result);
                    alert(`Test ${result.success ? 'succeeded' : 'failed'}: ${result.message}`);
                })
                .withFailureHandler((error) => {
                    console.error('‚ùå Test failed:', error);
                    alert('Test failed: ' + error.toString());
                })
                .testLogFromClient();
        };
        
        // SIMPLE TEST - Test basic web->Apps Script communication
        window.testEntityLogging = function() {
            console.log('üéØ Testing entity access logging...');
            
            google.script.run
                .withSuccessHandler((result) => {
                    console.log('‚úÖ Entity test result:', result);
                    alert('Entity logging test: ' + result);
                })
                .withFailureHandler((error) => {
                    console.error('‚ùå Entity test failed:', error);
                    alert('Entity test failed: ' + error.toString());
                })
                .testEntityAccess();
        };
        
        window.testConnection = function() {
            console.log('üîå Testing simple connection...');
            
            google.script.run
                .withSuccessHandler((result) => {
                    console.log('‚úÖ Connection test result:', result);
                    alert('Connection test: ' + result);
                })
                .withFailureHandler((error) => {
                    console.error('‚ùå Connection test failed:', error);
                    alert('Connection test failed: ' + error.toString());
                })
                .simpleConnectionTest();
        };

        window.simpleTest = function() {
            alert('Testing web->script communication...');
            
            // Test 1: Basic communication
            google.script.run
                .withSuccessHandler((result) => {
                    alert('SUCCESS: ' + result);
                    
                    // Test 2: Try to log to sheet
                    google.script.run
                        .withSuccessHandler((logResult) => {
                            alert('LOG RESULT: ' + logResult);
                        })
                        .withFailureHandler((logError) => {
                            alert('LOG ERROR: ' + logError.toString());
                        })
                        .simpleWebLogTest();
                })
                .withFailureHandler((error) => {
                    alert('COMMUNICATION ERROR: ' + error.toString());
                })
                .alertTest();
        };

        // React app will be rendered from DOMContentLoaded event handler
    </script>
</body>
</html>